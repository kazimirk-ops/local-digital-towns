<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Seller Dashboard</title>
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; background: #0a0e1a; color: #e2e8f0; min-height: 100vh; }
      a { color: #10b981; text-decoration: none; }

      .dash { display: flex; min-height: 100vh; }

      /* Sidebar */
      .sidebar {
        width: 220px; min-height: 100vh; background: #111827; border-right: 1px solid #1e293b;
        display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; z-index: 20;
      }
      .sidebar-header { padding: 20px 16px 12px; border-bottom: 1px solid #1e293b; }
      .sidebar-header .store-name { font-weight: 700; font-size: 15px; color: #e2e8f0; }
      .sidebar-header .store-sub { font-size: 12px; color: #64748b; margin-top: 2px; }
      .sidebar-nav { flex: 1; padding: 8px 0; }
      .sidebar-nav a {
        display: flex; align-items: center; gap: 10px; padding: 10px 16px; font-size: 14px;
        color: #94a3b8; transition: all .15s; border-left: 3px solid transparent;
      }
      .sidebar-nav a:hover { color: #e2e8f0; background: rgba(255,255,255,.04); }
      .sidebar-nav a.active { color: #10b981; border-left-color: #10b981; background: rgba(16,185,129,.08); }
      .sidebar-nav a .icon { width: 18px; text-align: center; font-size: 15px; }
      .sidebar-footer { padding: 16px; border-top: 1px solid #1e293b; }
      .sidebar-footer .rev-label { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: .05em; }
      .sidebar-footer .rev-amount { font-size: 20px; font-weight: 700; color: #10b981; margin-top: 4px; }
      .sidebar-footer .rev-period { font-size: 11px; color: #64748b; margin-top: 2px; }

      /* Mobile nav toggle */
      .mobile-header {
        display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 30;
        background: #111827; border-bottom: 1px solid #1e293b; padding: 12px 16px;
        align-items: center; justify-content: space-between;
      }
      .mobile-header .store-name { font-weight: 700; font-size: 15px; }
      .mobile-header button { background: none; border: none; color: #e2e8f0; font-size: 22px; cursor: pointer; padding: 4px 8px; }

      /* Main content */
      .main { flex: 1; margin-left: 220px; padding: 32px; }
      .main-title { font-size: 22px; font-weight: 700; margin-bottom: 24px; }

      /* Tab content */
      .tab-content { display: none; }
      .tab-content.active { display: block; }

      /* KPI grid */
      .kpi-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
      .kpi-card {
        background: #111827; border: 1px solid #1e293b; border-radius: 12px; padding: 20px;
      }
      .kpi-card .kpi-label { font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: .04em; }
      .kpi-card .kpi-value { font-size: 28px; font-weight: 700; color: #e2e8f0; margin-top: 6px; }
      .kpi-card .kpi-sub { font-size: 12px; color: #64748b; margin-top: 4px; }

      /* Placeholder card */
      .placeholder-card {
        background: #111827; border: 1px solid #1e293b; border-radius: 12px; padding: 40px;
        text-align: center;
      }
      .placeholder-card .ph-title { font-size: 18px; font-weight: 600; color: #94a3b8; margin-bottom: 8px; }
      .placeholder-card .ph-desc { font-size: 14px; color: #64748b; max-width: 400px; margin: 0 auto; line-height: 1.6; }

      /* Invoice metrics */
      .inv-metrics { display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
      .inv-metric { flex: 1; min-width: 140px; background: #111827; border: 1px solid #1e293b; border-radius: 12px; padding: 16px; }
      .inv-metric .im-label { font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: .04em; }
      .inv-metric .im-value { font-size: 24px; font-weight: 700; margin-top: 4px; }
      .inv-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
      .btn-green { background: #10b981; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; }
      .btn-green:hover { background: #059669; }
      .btn-gray { background: #374151; color: #e2e8f0; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; }
      .btn-gray:hover { background: #4b5563; }

      /* Invoice table */
      .inv-table { width: 100%; border-collapse: collapse; }
      .inv-table th { text-align: left; font-size: 12px; color: #64748b; text-transform: uppercase; padding: 8px 12px; border-bottom: 1px solid #1e293b; }
      .inv-table td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,.04); font-size: 14px; }
      .inv-table tr:hover td { background: rgba(255,255,255,.02); }
      .inv-badge { display: inline-block; padding: 2px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
      .inv-empty { text-align: center; padding: 40px; color: #64748b; }

      /* Invoice modal */
      .inv-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,.6); z-index: 100; align-items: center; justify-content: center; }
      .inv-modal { background: #1e293b; border-radius: 16px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 24px; position: relative; }
      .inv-modal h3 { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
      .inv-modal .close-btn { position: absolute; top: 12px; right: 16px; background: none; border: none; color: #94a3b8; font-size: 22px; cursor: pointer; }
      .inv-modal label { display: block; font-size: 13px; color: #94a3b8; margin-bottom: 4px; margin-top: 12px; }
      .inv-modal input, .inv-modal textarea { width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid #374151; background: #111827; color: #e2e8f0; font-size: 14px; }
      .inv-modal textarea { min-height: 60px; resize: vertical; }
      .inv-modal input:focus, .inv-modal textarea:focus { outline: none; border-color: #10b981; }
      .inv-line-row { display: flex; gap: 8px; align-items: center; margin-top: 6px; }
      .inv-line-row input { flex: 1; }
      .inv-line-row .qty-input { max-width: 60px; }
      .inv-line-row .price-input { max-width: 90px; }
      .inv-line-row .remove-line { background: none; border: none; color: #ef4444; font-size: 18px; cursor: pointer; padding: 4px 8px; }
      .inv-add-line { color: #10b981; font-size: 13px; cursor: pointer; margin-top: 8px; display: inline-block; background: none; border: none; }
      .inv-totals { margin-top: 16px; padding-top: 12px; border-top: 1px solid #374151; font-size: 14px; }
      .inv-totals div { display: flex; justify-content: space-between; padding: 3px 0; }
      .inv-totals .inv-total-row { font-weight: 700; font-size: 16px; color: #10b981; }
      .inv-modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }

      /* Responsive */
      @media (max-width: 768px) {
        .sidebar { transform: translateX(-100%); transition: transform .25s; width: 260px; }
        .sidebar.open { transform: translateX(0); }
        .mobile-header { display: flex; }
        .main { margin-left: 0; padding: 16px; padding-top: 64px; }
        .kpi-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 15; }
        .overlay.open { display: block; }
      }
    </style>
  </head>
  <body>

    <!-- Mobile header -->
    <div class="mobile-header">
      <span class="store-name" id="mobileStoreName">Dashboard</span>
      <button id="menuToggle">&#9776;</button>
    </div>
    <div class="overlay" id="overlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="store-name" id="sidebarStoreName">Loading...</div>
        <div class="store-sub">Seller Dashboard</div>
      </div>
      <nav class="sidebar-nav" id="sidebarNav">
        <a href="#overview" data-tab="overview" class="active"><span class="icon">&#9635;</span> Overview</a>
        <a href="#orders" data-tab="orders"><span class="icon">&#9993;</span> Orders</a>
        <a href="#invoices" data-tab="invoices"><span class="icon">&#9889;</span> Invoices</a>
        <a href="#products" data-tab="products"><span class="icon">&#9881;</span> Products</a>
        <a href="#analytics" data-tab="analytics"><span class="icon">&#9670;</span> Analytics</a>
        <a href="#facebook" data-tab="facebook"><span class="icon">&#402;</span> Facebook</a>
        <a href="#customers" data-tab="customers"><span class="icon">&#9786;</span> Customers</a>
        <a href="#marketing" data-tab="marketing"><span class="icon">&#9733;</span> Marketing</a>
        <a href="#settings" data-tab="settings"><span class="icon">&#9881;</span> Settings</a>
      </nav>
      <div class="sidebar-footer">
        <div class="rev-label">Monthly Revenue</div>
        <div class="rev-amount">&mdash;</div>
        <div class="rev-period" id="revPeriod">This month</div>
      </div>
    </aside>

    <!-- Main -->
    <div class="dash">
      <main class="main">

        <!-- Overview -->
        <div class="tab-content active" id="tab-overview">
          <div class="main-title">Overview</div>
          <div class="kpi-grid">
            <div class="kpi-card"><div class="kpi-label">Today's Revenue</div><div class="kpi-value">&mdash;</div><div class="kpi-sub">vs yesterday</div></div>
            <div class="kpi-card"><div class="kpi-label">Orders</div><div class="kpi-value">&mdash;</div><div class="kpi-sub">Today</div></div>
            <div class="kpi-card"><div class="kpi-label">Store Views</div><div class="kpi-value">&mdash;</div><div class="kpi-sub">Last 24h</div></div>
            <div class="kpi-card"><div class="kpi-label">Conversion Rate</div><div class="kpi-value">&mdash;</div><div class="kpi-sub">Views to orders</div></div>
            <div class="kpi-card"><div class="kpi-label">Pending Deposits</div><div class="kpi-value">&mdash;</div><div class="kpi-sub">Awaiting payout</div></div>
          </div>
        </div>

        <!-- Orders / Deposits -->
        <div class="tab-content" id="tab-orders">
          <div class="main-title">Orders &amp; Deposits</div>
          <div class="inv-header">
            <span style="font-size:14px;color:#64748b;" id="depCount">0 deposits</span>
          </div>
          <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;overflow:hidden;">
            <table class="inv-table">
              <thead><tr><th>Order</th><th>Buyer</th><th>Amount</th><th>%</th><th>Status</th><th>Expires</th><th></th></tr></thead>
              <tbody id="depTableBody"><tr><td colspan="7" class="inv-empty">No deposits yet</td></tr></tbody>
            </table>
          </div>
        </div>

        <!-- Invoices -->
        <div class="tab-content" id="tab-invoices">
          <div class="main-title">Invoices</div>
          <div class="inv-metrics">
            <div class="inv-metric"><div class="im-label">Collected</div><div class="im-value" id="invCollected" style="color:#10b981;">$0.00</div></div>
            <div class="inv-metric"><div class="im-label">Outstanding</div><div class="im-value" id="invOutstanding" style="color:#f59e0b;">$0.00</div></div>
            <div class="inv-metric"><div class="im-label">Fees Earned</div><div class="im-value" id="invFees" style="color:#94a3b8;">$0.00</div></div>
          </div>
          <div class="inv-header">
            <span style="font-size:14px;color:#64748b;" id="invCount">0 invoices</span>
            <button type="button" class="btn-green" id="newInvBtn">+ New Invoice</button>
          </div>
          <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;overflow:hidden;">
            <table class="inv-table">
              <thead><tr><th>Invoice</th><th>Customer</th><th>Amount</th><th>Status</th><th>Date</th><th></th></tr></thead>
              <tbody id="invTableBody"><tr><td colspan="6" class="inv-empty">No invoices yet</td></tr></tbody>
            </table>
          </div>
        </div>

        <!-- Products -->
        <div class="tab-content" id="tab-products">
          <div class="main-title">Products</div>
          <div class="placeholder-card">
            <div class="ph-title">Coming Soon</div>
            <div class="ph-desc">Add, edit, and manage your product catalog. Set prices, upload photos, and manage inventory.</div>
          </div>
        </div>

        <!-- Analytics -->
        <div class="tab-content" id="tab-analytics">
          <div class="main-title">Analytics</div>
          <div class="placeholder-card">
            <div class="ph-title">Coming Soon</div>
            <div class="ph-desc">View store performance, traffic sources, top products, and revenue trends over time.</div>
          </div>
        </div>

        <!-- Facebook -->
        <div class="tab-content" id="tab-facebook">
          <div class="main-title">Facebook</div>
          <div class="placeholder-card">
            <div class="ph-title">Coming Soon</div>
            <div class="ph-desc">Connect your Facebook page, auto-post new products, and manage social engagement.</div>
          </div>
        </div>

        <!-- Customers -->
        <div class="tab-content" id="tab-customers">
          <div class="main-title">Customers</div>
          <div class="placeholder-card">
            <div class="ph-title">Coming Soon</div>
            <div class="ph-desc">View customer profiles, order history, and manage your customer relationships.</div>
          </div>
        </div>

        <!-- Marketing -->
        <div class="tab-content" id="tab-marketing">
          <div class="main-title">Marketing</div>
          <div class="placeholder-card">
            <div class="ph-title">Coming Soon</div>
            <div class="ph-desc">Create promotions, discount codes, and email campaigns to grow your store.</div>
          </div>
        </div>

        <!-- Settings -->
        <div class="tab-content" id="tab-settings">
          <div class="main-title">Settings</div>
          <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;padding:24px;max-width:480px;">
            <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">Deposit Settings</h3>
            <label style="display:block;font-size:13px;color:#94a3b8;margin-bottom:8px;">Deposit Mode</label>
            <select id="settDepositMode" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #374151;background:#0a0e1a;color:#e2e8f0;font-size:14px;margin-bottom:16px;">
              <option value="none">None — No deposits required</option>
              <option value="standard">Standard (5%) — 5% deposit on all orders</option>
              <option value="double">Double (10%) — 10% deposit on all orders</option>
            </select>
            <label style="display:block;font-size:13px;color:#94a3b8;margin-bottom:4px;">Ghost Timeout (hours)</label>
            <p style="font-size:12px;color:#475569;margin-bottom:8px;">Hours before a pending deposit is auto-forfeited</p>
            <input type="number" id="settGhostHours" min="1" max="720" value="48" style="width:120px;padding:10px 12px;border-radius:8px;border:1px solid #374151;background:#0a0e1a;color:#e2e8f0;font-size:14px;margin-bottom:20px;" />
            <div>
              <button type="button" class="btn-green" id="saveSettingsBtn">Save Settings</button>
              <span id="settSaved" style="margin-left:12px;color:#10b981;font-size:13px;display:none;">Saved!</span>
            </div>
          </div>
        </div>

      </main>
    </div>

    <!-- Invoice Modal -->
    <div class="inv-modal-overlay" id="invModalOverlay">
      <div class="inv-modal">
        <button class="close-btn" id="invCloseBtn">&times;</button>
        <h3>Create Invoice</h3>
        <label>Customer Email *</label>
        <input type="email" id="invEmail" placeholder="customer@example.com" />
        <label>Customer Name</label>
        <input type="text" id="invName" placeholder="Jane Doe" />
        <label>Phone</label>
        <input type="tel" id="invPhone" placeholder="(555) 123-4567" />
        <label>Line Items *</label>
        <div id="invLines"></div>
        <button class="inv-add-line" id="addLineBtn">+ Add line item</button>
        <div class="inv-totals">
          <div><span>Subtotal</span><span id="invSubtotal">$0.00</span></div>
          <div><span>Platform Fee (5%)</span><span id="invFee">$0.00</span></div>
          <div class="inv-total-row"><span>Total</span><span id="invTotal">$0.00</span></div>
        </div>
        <label>Notes</label>
        <textarea id="invNotes" placeholder="Optional notes for the customer..."></textarea>
        <label>Due Date</label>
        <input type="date" id="invDueDate" />
        <div class="inv-modal-actions">
          <button class="btn-gray" id="invCancelBtn">Cancel</button>
          <button class="btn-green" id="invSubmitBtn">Create Draft</button>
        </div>
      </div>
    </div>

    <script>
    (function(){
      var place = window.SELLER_PLACE;
      if(!place){ window.location.href = "/login"; return; }

      // Set store name
      document.getElementById("sidebarStoreName").textContent = place.name;
      document.getElementById("mobileStoreName").textContent = place.name;

      // Tab switching
      var navLinks = document.querySelectorAll("#sidebarNav a");
      var tabs = document.querySelectorAll(".tab-content");

      function switchTab(tabId){
        tabs.forEach(function(t){ t.classList.remove("active"); });
        navLinks.forEach(function(a){ a.classList.remove("active"); });
        var target = document.getElementById("tab-" + tabId);
        if(target) target.classList.add("active");
        var link = document.querySelector('#sidebarNav a[data-tab="' + tabId + '"]');
        if(link) link.classList.add("active");
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("overlay").classList.remove("open");
      }

      navLinks.forEach(function(a){
        a.addEventListener("click", function(e){
          e.preventDefault();
          var tab = this.getAttribute("data-tab");
          switchTab(tab);
          history.replaceState(null, "", "#" + tab);
        });
      });

      // Handle hash on load
      var hash = window.location.hash.replace("#","");
      if(hash && document.getElementById("tab-" + hash)){
        switchTab(hash);
      }

      // Mobile toggle
      document.getElementById("menuToggle").addEventListener("click", function(){
        document.getElementById("sidebar").classList.toggle("open");
        document.getElementById("overlay").classList.toggle("open");
      });
      document.getElementById("overlay").addEventListener("click", function(){
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("overlay").classList.remove("open");
      });

      /* ─── Invoice helpers ─── */
      function fmt(n){ return "$" + (Number(n)||0).toFixed(2); }

      function calcInvTotals(){
        var rows = document.querySelectorAll("#invLines .inv-line-row");
        var sub = 0;
        rows.forEach(function(r){
          var q = Number(r.querySelector(".line-qty").value) || 0;
          var p = Number(r.querySelector(".line-price").value) || 0;
          sub += q * p;
        });
        var fee = Math.round(sub * 5) / 100;
        document.getElementById("invSubtotal").textContent = fmt(sub);
        document.getElementById("invFee").textContent = fmt(fee);
        document.getElementById("invTotal").textContent = fmt(sub + fee);
      }

      function addInvLine(){
        var wrap = document.getElementById("invLines");
        var row = document.createElement("div");
        row.className = "inv-line-row";
        row.innerHTML = '<input type="text" placeholder="Item name" class="line-title" />'
          + '<input type="number" min="1" value="1" class="qty-input line-qty" />'
          + '<input type="number" step="0.01" min="0" placeholder="Price" class="price-input line-price" />'
          + '<button type="button" class="remove-line">&times;</button>';
        wrap.appendChild(row);
        row.querySelector(".line-qty").addEventListener("input", calcInvTotals);
        row.querySelector(".line-price").addEventListener("input", calcInvTotals);
      }

      function openInvModal(){
        document.getElementById("invEmail").value = "";
        document.getElementById("invName").value = "";
        document.getElementById("invPhone").value = "";
        document.getElementById("invNotes").value = "";
        document.getElementById("invDueDate").value = "";
        document.getElementById("invLines").innerHTML = "";
        addInvLine();
        calcInvTotals();
        document.getElementById("invSubmitBtn").disabled = false;
        document.getElementById("invSubmitBtn").textContent = "Create Draft";
        document.getElementById("invModalOverlay").style.display = "flex";
      }

      function closeInvModal(){
        document.getElementById("invModalOverlay").style.display = "none";
      }

      function badgeHtml(status){
        var colors = { draft: "#374151", sent: "#2563eb", paid: "#10b981", cancelled: "#ef4444" };
        var bg = colors[status] || "#374151";
        return '<span class="inv-badge" style="background:' + bg + ';color:#fff;">' + (status||"draft") + '</span>';
      }

      async function submitInvoice(){
        var btn = document.getElementById("invSubmitBtn");
        btn.disabled = true; btn.textContent = "Saving...";
        var rows = document.querySelectorAll("#invLines .inv-line-row");
        var items = [];
        rows.forEach(function(r){
          var title = r.querySelector(".line-title").value.trim();
          var qty = Number(r.querySelector(".line-qty").value) || 1;
          var price = Number(r.querySelector(".line-price").value) || 0;
          if(title) items.push({ title: title, quantity: qty, unitPrice: price });
        });
        if(!items.length){ alert("Add at least one line item"); btn.disabled = false; btn.textContent = "Create Draft"; return; }
        var email = document.getElementById("invEmail").value.trim();
        if(!email){ alert("Customer email is required"); btn.disabled = false; btn.textContent = "Create Draft"; return; }
        try {
          var resp = await fetch("/api/seller/invoices", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              buyerEmail: email,
              buyerName: document.getElementById("invName").value.trim(),
              buyerPhone: document.getElementById("invPhone").value.trim(),
              items: items,
              notes: document.getElementById("invNotes").value.trim(),
              dueDate: document.getElementById("invDueDate").value || null
            })
          });
          if(!resp.ok) throw new Error((await resp.json()).error || "Failed");
          closeInvModal();
          loadInvoices();
        } catch(err){
          alert("Error: " + err.message);
        }
        btn.disabled = false; btn.textContent = "Create Draft";
      }

      async function sendInvoice(id){
        if(!confirm("Mark this invoice as sent?")) return;
        try {
          var resp = await fetch("/api/seller/invoices/" + id + "/send", { method: "PUT" });
          if(!resp.ok) throw new Error("Failed");
          loadInvoices();
        } catch(err){ alert("Error: " + err.message); }
      }

      async function loadInvoices(){
        try {
          var resp = await fetch("/api/seller/invoices");
          if(!resp.ok) return;
          var rows = await resp.json();
          var body = document.getElementById("invTableBody");
          var collected = 0, outstanding = 0, fees = 0;
          rows.forEach(function(inv){
            var t = Number(inv.total) || 0;
            var f = Number(inv.platform_fee || inv.platformfee || inv.platformFee) || 0;
            if(inv.status === "paid"){ collected += t; fees += f; }
            if(inv.status === "sent" || inv.status === "draft") outstanding += t;
          });
          document.getElementById("invCollected").textContent = fmt(collected);
          document.getElementById("invOutstanding").textContent = fmt(outstanding);
          document.getElementById("invFees").textContent = fmt(fees);
          document.getElementById("invCount").textContent = rows.length + " invoice" + (rows.length !== 1 ? "s" : "");
          if(!rows.length){
            body.innerHTML = '<tr><td colspan="6" class="inv-empty">No invoices yet — create your first one!</td></tr>';
            return;
          }
          body.innerHTML = rows.map(function(inv){
            var date = inv.created_at || inv.createdat || inv.createdAt || "";
            if(date) date = new Date(date).toLocaleDateString();
            var name = inv.buyer_name || inv.buyername || inv.buyerName || inv.buyer_email || inv.buyeremail || inv.buyerEmail || "";
            var actions = inv.status === "draft" ? '<button type="button" class="btn-green inv-send-btn" data-id="' + inv.id + '" style="padding:4px 12px;font-size:12px;">Send</button>' : "";
            return '<tr>'
              + '<td>#' + inv.id + '</td>'
              + '<td>' + name + '</td>'
              + '<td>' + fmt(inv.total) + '</td>'
              + '<td>' + badgeHtml(inv.status) + '</td>'
              + '<td style="color:#64748b;">' + date + '</td>'
              + '<td>' + actions + '</td>'
              + '</tr>';
          }).join("");
        } catch(err){ console.error("LOAD_INVOICES_ERROR", err); }
      }

      /* ─── Bind all events via addEventListener ─── */

      // New Invoice button
      document.getElementById("newInvBtn").addEventListener("click", openInvModal);

      // Modal overlay click-to-close (only when clicking backdrop, not modal itself)
      document.getElementById("invModalOverlay").addEventListener("click", function(e){
        if(e.target === this) closeInvModal();
      });

      // Modal close button
      document.getElementById("invCloseBtn").addEventListener("click", closeInvModal);

      // Modal cancel button
      document.getElementById("invCancelBtn").addEventListener("click", closeInvModal);

      // Modal submit button
      document.getElementById("invSubmitBtn").addEventListener("click", submitInvoice);

      // Add line item button
      document.getElementById("addLineBtn").addEventListener("click", addInvLine);

      // Event delegation: remove line item buttons (dynamically created)
      document.getElementById("invLines").addEventListener("click", function(e){
        var btn = e.target.closest(".remove-line");
        if(btn){
          btn.parentElement.remove();
          calcInvTotals();
        }
      });

      // Event delegation: send invoice buttons (dynamically created in table)
      document.getElementById("invTableBody").addEventListener("click", function(e){
        var btn = e.target.closest(".inv-send-btn");
        if(btn){
          var id = Number(btn.getAttribute("data-id"));
          if(id) sendInvoice(id);
        }
      });

      /* ─── Settings logic ─── */
      async function loadSettings(){
        try {
          var resp = await fetch("/api/seller/settings");
          if(!resp.ok) return;
          var s = await resp.json();
          document.getElementById("settDepositMode").value = s.depositMode || "none";
          document.getElementById("settGhostHours").value = s.ghostTimeoutHours || 48;
        } catch(err){ console.error("LOAD_SETTINGS_ERROR", err); }
      }

      async function saveSettings(){
        var btn = document.getElementById("saveSettingsBtn");
        btn.disabled = true; btn.textContent = "Saving...";
        try {
          var resp = await fetch("/api/seller/settings", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              depositMode: document.getElementById("settDepositMode").value,
              ghostTimeoutHours: Number(document.getElementById("settGhostHours").value) || 48
            })
          });
          if(!resp.ok) throw new Error((await resp.json()).error || "Failed");
          var saved = document.getElementById("settSaved");
          saved.style.display = "inline";
          setTimeout(function(){ saved.style.display = "none"; }, 2500);
        } catch(err){ alert("Error: " + err.message); }
        btn.disabled = false; btn.textContent = "Save Settings";
      }

      document.getElementById("saveSettingsBtn").addEventListener("click", saveSettings);

      /* ─── Deposits logic ─── */
      function depBadge(status){
        var colors = { pending: "#eab308", collected: "#10b981", forfeited: "#ef4444", refunded: "#3b82f6" };
        var bg = colors[status] || "#374151";
        return '<span class="inv-badge" style="background:' + bg + ';color:#fff;">' + (status || "pending") + '</span>';
      }

      async function loadDeposits(){
        try {
          var resp = await fetch("/api/seller/deposits");
          if(!resp.ok) return;
          var rows = await resp.json();
          var body = document.getElementById("depTableBody");
          document.getElementById("depCount").textContent = rows.length + " deposit" + (rows.length !== 1 ? "s" : "");
          if(!rows.length){
            body.innerHTML = '<tr><td colspan="7" class="inv-empty">No deposits yet</td></tr>';
            return;
          }
          body.innerHTML = rows.map(function(d){
            var exp = d.expires_at || d.expiresat || d.expiresAt || "";
            if(exp) exp = new Date(exp).toLocaleString();
            var email = d.buyer_email || d.buyeremail || d.buyerEmail || "";
            var st = d.status || "pending";
            var actions = "";
            if(st === "pending") actions = '<button type="button" class="dep-forfeit-btn" data-id="' + d.id + '" style="padding:3px 10px;font-size:12px;font-weight:600;background:#ef4444;color:#fff;border:none;border-radius:6px;cursor:pointer;">Forfeit</button>';
            if(st === "collected") actions = '<button type="button" class="dep-refund-btn" data-id="' + d.id + '" style="padding:3px 10px;font-size:12px;font-weight:600;background:#3b82f6;color:#fff;border:none;border-radius:6px;cursor:pointer;">Refund</button>';
            return '<tr>'
              + '<td>#' + (d.order_id || d.orderid || d.orderId || "") + '</td>'
              + '<td>' + email + '</td>'
              + '<td>' + fmt(d.amount) + '</td>'
              + '<td>' + (d.deposit_percent || d.depositpercent || d.depositPercent || 5) + '%</td>'
              + '<td>' + depBadge(st) + '</td>'
              + '<td style="color:#64748b;font-size:12px;">' + exp + '</td>'
              + '<td>' + actions + '</td>'
              + '</tr>';
          }).join("");
        } catch(err){ console.error("LOAD_DEPOSITS_ERROR", err); }
      }

      async function forfeitDeposit(id){
        if(!confirm("Forfeit this deposit? This cannot be undone.")) return;
        try {
          var resp = await fetch("/api/deposits/" + id + "/forfeit", { method: "PUT" });
          if(!resp.ok) throw new Error("Failed");
          loadDeposits();
        } catch(err){ alert("Error: " + err.message); }
      }

      async function refundDeposit(id){
        if(!confirm("Refund this deposit?")) return;
        try {
          var resp = await fetch("/api/deposits/" + id + "/refund", { method: "PUT" });
          if(!resp.ok) throw new Error("Failed");
          loadDeposits();
        } catch(err){ alert("Error: " + err.message); }
      }

      // Event delegation for deposit action buttons
      document.getElementById("depTableBody").addEventListener("click", function(e){
        var fb = e.target.closest(".dep-forfeit-btn");
        if(fb){ forfeitDeposit(Number(fb.getAttribute("data-id"))); return; }
        var rb = e.target.closest(".dep-refund-btn");
        if(rb){ refundDeposit(Number(rb.getAttribute("data-id"))); return; }
      });

      /* ─── Tab auto-load observers ─── */
      function watchTab(tabId, loadFn){
        if(window.location.hash === "#" + tabId) loadFn();
        var loaded = window.location.hash === "#" + tabId;
        var obs = new MutationObserver(function(){
          var el = document.getElementById("tab-" + tabId);
          if(el && el.classList.contains("active")){
            if(!loaded){ loaded = true; loadFn(); }
          } else { loaded = false; }
        });
        obs.observe(document.getElementById("tab-" + tabId), { attributes: true, attributeFilter: ["class"] });
      }

      watchTab("invoices", loadInvoices);
      watchTab("orders", loadDeposits);
      watchTab("settings", loadSettings);

    })();
    </script>
  </body>
</html>
