<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Seller Dashboard</title>
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; background: #0a0e1a; color: #e2e8f0; min-height: 100vh; }
      a { color: #10b981; text-decoration: none; }

      .dash { display: flex; min-height: 100vh; }

      /* Sidebar */
      .sidebar {
        width: 220px; min-height: 100vh; background: #111827; border-right: 1px solid #1e293b;
        display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; z-index: 20;
      }
      .sidebar-header { padding: 20px 16px 12px; border-bottom: 1px solid #1e293b; }
      .sidebar-header .store-name { font-weight: 700; font-size: 15px; color: #e2e8f0; }
      .sidebar-header .store-sub { font-size: 12px; color: #64748b; margin-top: 2px; }
      .sidebar-nav { flex: 1; padding: 8px 0; }
      .sidebar-nav a {
        display: flex; align-items: center; gap: 10px; padding: 10px 16px; font-size: 14px;
        color: #94a3b8; transition: all .15s; border-left: 3px solid transparent;
      }
      .sidebar-nav a:hover { color: #e2e8f0; background: rgba(255,255,255,.04); }
      .sidebar-nav a.active { color: #10b981; border-left-color: #10b981; background: rgba(16,185,129,.08); }
      .sidebar-nav a .icon { width: 18px; text-align: center; font-size: 15px; }
      .sidebar-footer { padding: 16px; border-top: 1px solid #1e293b; }
      .sidebar-footer .rev-label { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: .05em; }
      .sidebar-footer .rev-amount { font-size: 20px; font-weight: 700; color: #10b981; margin-top: 4px; }
      .sidebar-footer .rev-period { font-size: 11px; color: #64748b; margin-top: 2px; }

      /* Mobile nav toggle */
      .mobile-header {
        display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 30;
        background: #111827; border-bottom: 1px solid #1e293b; padding: 12px 16px;
        align-items: center; justify-content: space-between;
      }
      .mobile-header .store-name { font-weight: 700; font-size: 15px; }
      .mobile-header button { background: none; border: none; color: #e2e8f0; font-size: 22px; cursor: pointer; padding: 4px 8px; }

      /* Main content */
      .main { flex: 1; margin-left: 220px; padding: 32px; }
      .main-title { font-size: 22px; font-weight: 700; margin-bottom: 24px; }

      /* Tab content */
      .tab-content { display: none; }
      .tab-content.active { display: block; }

      /* KPI grid */
      .kpi-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
      .kpi-card {
        background: #111827; border: 1px solid #1e293b; border-radius: 12px; padding: 20px;
      }
      .kpi-card .kpi-label { font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: .04em; }
      .kpi-card .kpi-value { font-size: 28px; font-weight: 700; color: #e2e8f0; margin-top: 6px; }
      .kpi-card .kpi-sub { font-size: 12px; color: #64748b; margin-top: 4px; }
      .rev-bar { transition: opacity .15s; }
      .rev-bar:hover { opacity: 0.7; }

      /* Placeholder card */
      .placeholder-card {
        background: #111827; border: 1px solid #1e293b; border-radius: 12px; padding: 40px;
        text-align: center;
      }
      .placeholder-card .ph-title { font-size: 18px; font-weight: 600; color: #94a3b8; margin-bottom: 8px; }
      .placeholder-card .ph-desc { font-size: 14px; color: #64748b; max-width: 400px; margin: 0 auto; line-height: 1.6; }

      /* Invoice metrics */
      .inv-metrics { display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
      .inv-metric { flex: 1; min-width: 140px; background: #111827; border: 1px solid #1e293b; border-radius: 12px; padding: 16px; }
      .inv-metric .im-label { font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: .04em; }
      .inv-metric .im-value { font-size: 24px; font-weight: 700; margin-top: 4px; }
      .inv-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
      .btn-green { background: #10b981; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; }
      .btn-green:hover { background: #059669; }
      .btn-gray { background: #374151; color: #e2e8f0; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; }
      .btn-gray:hover { background: #4b5563; }

      /* Invoice table */
      .inv-table { width: 100%; border-collapse: collapse; }
      .inv-table th { text-align: left; font-size: 12px; color: #64748b; text-transform: uppercase; padding: 8px 12px; border-bottom: 1px solid #1e293b; }
      .inv-table td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,.04); font-size: 14px; }
      .inv-table tr:hover td { background: rgba(255,255,255,.02); }
      .inv-badge { display: inline-block; padding: 2px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
      .inv-empty { text-align: center; padding: 40px; color: #64748b; }

      /* Invoice modal */
      .inv-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,.6); z-index: 100; align-items: center; justify-content: center; }
      .inv-modal { background: #1e293b; border-radius: 16px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 24px; position: relative; }
      .inv-modal h3 { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
      .inv-modal .close-btn { position: absolute; top: 12px; right: 16px; background: none; border: none; color: #94a3b8; font-size: 22px; cursor: pointer; }
      .inv-modal label { display: block; font-size: 13px; color: #94a3b8; margin-bottom: 4px; margin-top: 12px; }
      .inv-modal input, .inv-modal textarea { width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid #374151; background: #111827; color: #e2e8f0; font-size: 14px; }
      .inv-modal textarea { min-height: 60px; resize: vertical; }
      .inv-modal input:focus, .inv-modal textarea:focus { outline: none; border-color: #10b981; }
      .inv-line-row { display: flex; gap: 8px; align-items: center; margin-top: 6px; }
      .inv-line-row input { flex: 1; }
      .inv-line-row .qty-input { max-width: 60px; }
      .inv-line-row .price-input { max-width: 90px; }
      .inv-line-row .remove-line { background: none; border: none; color: #ef4444; font-size: 18px; cursor: pointer; padding: 4px 8px; }
      .inv-add-line { color: #10b981; font-size: 13px; cursor: pointer; margin-top: 8px; display: inline-block; background: none; border: none; }
      .inv-totals { margin-top: 16px; padding-top: 12px; border-top: 1px solid #374151; font-size: 14px; }
      .inv-totals div { display: flex; justify-content: space-between; padding: 3px 0; }
      .inv-totals .inv-total-row { font-weight: 700; font-size: 16px; color: #10b981; }
      .inv-modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }

      /* Responsive */
      @media (max-width: 768px) {
        .sidebar { transform: translateX(-100%); transition: transform .25s; width: 260px; }
        .sidebar.open { transform: translateX(0); }
        .mobile-header { display: flex; }
        .main { margin-left: 0; padding: 16px; padding-top: 64px; }
        .kpi-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 15; }
        .overlay.open { display: block; }
      }
    </style>
  </head>
  <body>

    <!-- Mobile header -->
    <div class="mobile-header">
      <span class="store-name" id="mobileStoreName">Dashboard</span>
      <button id="menuToggle">&#9776;</button>
    </div>
    <div class="overlay" id="overlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="store-name" id="sidebarStoreName">Loading...</div>
        <div class="store-sub">Seller Dashboard</div>
      </div>
      <nav class="sidebar-nav" id="sidebarNav">
        <a href="#overview" data-tab="overview" class="active"><span class="icon">&#9635;</span> Overview</a>
        <a href="#orders" data-tab="orders"><span class="icon">&#9993;</span> Orders</a>
        <a href="#invoices" data-tab="invoices"><span class="icon">&#9889;</span> Invoices</a>
        <a href="#products" data-tab="products"><span class="icon">&#9881;</span> Products</a>
        <a href="#analytics" data-tab="analytics"><span class="icon">&#9670;</span> Analytics</a>
        <a href="#facebook" data-tab="facebook"><span class="icon">&#402;</span> Facebook</a>
        <a href="#customers" data-tab="customers"><span class="icon">&#9786;</span> Customers</a>
        <a href="#marketing" data-tab="marketing"><span class="icon">&#9733;</span> Marketing</a>
        <a href="#settings" data-tab="settings"><span class="icon">&#9881;</span> Settings</a>
      </nav>
      <div class="sidebar-footer">
        <div class="rev-label">Monthly Revenue</div>
        <div class="rev-amount" id="sidebarMonthlyRev">&mdash;</div>
        <div class="rev-period" id="revPeriod">This month</div>
      </div>
    </aside>

    <!-- Main -->
    <div class="dash">
      <main class="main">
        <a href="/" style="color:#94a3b8;text-decoration:none;font-size:14px;margin-bottom:8px;display:inline-block;">‚Üê Back to Town</a>

        <!-- Overview -->
        <div class="tab-content active" id="tab-overview">
          <div class="main-title">Overview</div>
          <div class="kpi-grid">
            <div class="kpi-card"><div class="kpi-label">Today's Revenue</div><div class="kpi-value" id="kpiTodayRev" style="color:#10b981;">&mdash;</div><div class="kpi-sub" id="kpiTodayOrders">0 orders today</div></div>
            <div class="kpi-card"><div class="kpi-label">Today's Orders</div><div class="kpi-value" id="kpiTodayOrd" style="color:#3b82f6;">&mdash;</div><div class="kpi-sub">Paid invoices today</div></div>
            <div class="kpi-card"><div class="kpi-label">Total Revenue</div><div class="kpi-value" id="kpiTotalRev" style="color:#10b981;">&mdash;</div><div class="kpi-sub" id="kpiTotalOrders">0 orders all time</div></div>
            <div class="kpi-card"><div class="kpi-label">Outstanding Invoices</div><div class="kpi-value" id="kpiOutstanding" style="color:#f59e0b;">&mdash;</div><div class="kpi-sub">Sent &amp; unpaid</div></div>
            <div class="kpi-card"><div class="kpi-label">Pending Deposits</div><div class="kpi-value" id="kpiDeposits" style="color:#ef4444;">&mdash;</div><div class="kpi-sub" id="kpiDepCount">0 pending</div></div>
          </div>
          <!-- Revenue Chart (last 30 days) -->
          <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;padding:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
              <h3 style="font-size:15px;font-weight:700;margin:0;">Revenue ‚Äî Last 30 Days</h3>
              <span style="font-size:12px;color:#64748b;" id="chartTotal"></span>
            </div>
            <div id="revChart" style="display:flex;align-items:flex-end;gap:3px;height:140px;"></div>
            <div id="revChartLabels" style="display:flex;gap:3px;margin-top:6px;"></div>
          </div>
        </div>

        <!-- Orders / Deposits -->
        <div class="tab-content" id="tab-orders">
          <div class="main-title">Orders &amp; Deposits</div>
          <div class="inv-header">
            <span style="font-size:14px;color:#64748b;" id="depCount">0 deposits</span>
          </div>
          <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;overflow:hidden;">
            <table class="inv-table">
              <thead><tr><th>Order</th><th>Buyer</th><th>Amount</th><th>%</th><th>Status</th><th>Expires</th><th></th></tr></thead>
              <tbody id="depTableBody"><tr><td colspan="7" class="inv-empty">No deposits yet</td></tr></tbody>
            </table>
          </div>

          <div style="background:#1e293b;border-radius:12px;padding:20px;margin-top:20px;">
            <h3 style="font-size:16px;margin-bottom:12px;">üè™ Local Pickup Deposits</h3>
            <p style="color:#94a3b8;font-size:13px;margin-bottom:16px;">Create a 5% non-refundable deposit for cash pickup sales to prevent no-shows.</p>
            <div style="display:grid;gap:10px;margin-bottom:16px;">
              <input type="text" id="depBuyerName" placeholder="Buyer Name *" style="padding:10px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;">
              <input type="email" id="depBuyerEmail" placeholder="Buyer Email (optional)" style="padding:10px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;">
              <input type="text" id="depDescription" placeholder="Item Description" style="padding:10px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;">
              <input type="number" id="depTotalPrice" placeholder="Total Sale Price ($) *" min="20" step="0.01" style="padding:10px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;">
              <div id="depPreview" style="color:#10b981;font-size:14px;font-weight:600;display:none;"></div>
            </div>
            <button id="createDepositBtn" style="padding:10px 20px;background:#10b981;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">Create & Copy Link</button>
            <div id="depResult" style="display:none;margin-top:12px;padding:12px;background:#0f172a;border-radius:8px;">
              <input type="text" id="depLink" readonly style="width:100%;padding:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#e2e8f0;font-size:13px;margin-bottom:8px;">
              <button id="copyDepLink" style="padding:6px 14px;background:#6366f1;color:#fff;border:none;border-radius:6px;font-size:13px;cursor:pointer;">Copy Link</button>
            </div>
            <table style="width:100%;margin-top:16px;font-size:13px;border-collapse:collapse;" id="cashDepositsTable">
              <thead><tr style="color:#94a3b8;border-bottom:1px solid #334155;"><th style="text-align:left;padding:8px;">Date</th><th>Buyer</th><th>Item</th><th>Total</th><th>Deposit</th><th>Status</th><th>Action</th></tr></thead>
              <tbody id="cashDepositsBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Invoices -->
        <div class="tab-content" id="tab-invoices">
          <div class="main-title">Invoices</div>
          <div class="inv-metrics">
            <div class="inv-metric"><div class="im-label">Collected</div><div class="im-value" id="invCollected" style="color:#10b981;">$0.00</div></div>
            <div class="inv-metric"><div class="im-label">Outstanding</div><div class="im-value" id="invOutstanding" style="color:#f59e0b;">$0.00</div></div>
            <div class="inv-metric"><div class="im-label">Fees Earned</div><div class="im-value" id="invFees" style="color:#94a3b8;">$0.00</div></div>
          </div>
          <div class="inv-header">
            <span style="font-size:14px;color:#64748b;" id="invCount">0 invoices</span>
            <button type="button" class="btn-green" id="newInvBtn">+ New Invoice</button>
          </div>
          <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;overflow:hidden;">
            <table class="inv-table">
              <thead><tr><th>Invoice</th><th>Customer</th><th>Amount</th><th>Status</th><th>Date</th><th></th></tr></thead>
              <tbody id="invTableBody"><tr><td colspan="6" class="inv-empty">No invoices yet</td></tr></tbody>
            </table>
          </div>
        </div>

        <!-- Products -->
        <div class="tab-content" id="tab-products">
          <div class="main-title">Products</div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <span id="prodCount" style="color:#94a3b8;font-size:14px;">0 products</span>
            <button type="button" id="prodRefreshBtn" class="btn-gray" style="padding:6px 16px;font-size:13px;">Refresh</button>
          </div>
          <div id="prodGrid" style="background:#111827;border:1px solid #1e293b;border-radius:12px;overflow:hidden;">
            <table class="inv-table">
              <thead><tr><th>Image</th><th>Title</th><th>Price</th><th>Qty</th><th>Status</th><th></th></tr></thead>
              <tbody id="prodTableBody">
                <tr><td colspan="6" class="inv-empty">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Product Edit Modal -->
        <div id="prodEditOverlay" class="inv-modal-overlay">
          <div class="inv-modal">
            <div style="font-size:18px;font-weight:700;color:#e2e8f0;margin-bottom:16px;">Edit Product</div>
            <input type="hidden" id="prodEditId">
            <label style="font-size:12px;color:#64748b;display:block;margin-bottom:4px;">Title</label>
            <input type="text" id="prodEditTitle" style="margin-bottom:12px;">
            <label style="font-size:12px;color:#64748b;display:block;margin-bottom:4px;">Price ($)</label>
            <input type="number" id="prodEditPrice" step="0.01" min="0" style="margin-bottom:12px;">
            <label style="font-size:12px;color:#64748b;display:block;margin-bottom:4px;">Quantity</label>
            <input type="number" id="prodEditQty" min="0" style="margin-bottom:12px;">
            <label style="font-size:12px;color:#64748b;display:block;margin-bottom:4px;">Status</label>
            <div style="margin-bottom:16px;">
              <button type="button" id="prodStatusToggle" class="inv-badge" style="cursor:pointer;padding:4px 14px;font-size:13px;">active</button>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
              <button type="button" id="prodEditCancel" class="btn-gray" style="padding:8px 16px;font-size:13px;">Cancel</button>
              <button type="button" id="prodEditSave" class="btn-green" style="padding:8px 16px;font-size:13px;">Save</button>
            </div>
          </div>
        </div>

        <!-- Analytics -->
        <div class="tab-content" id="tab-analytics">
          <div class="main-title">Analytics</div>

          <!-- Metric cards -->
          <div class="kpi-grid" style="margin-bottom:24px;">
            <div class="kpi-card"><div class="kpi-label">Avg Order Value</div><div class="kpi-value" id="anAvgOrder" style="color:#10b981;">&mdash;</div><div class="kpi-sub">Per paid invoice</div></div>
            <div class="kpi-card"><div class="kpi-label">Conversion Rate</div><div class="kpi-value" id="anConvRate" style="color:#3b82f6;">&mdash;</div><div class="kpi-sub" id="anConvSub">Paid / total invoices</div></div>
            <div class="kpi-card"><div class="kpi-label">Total Customers</div><div class="kpi-value" id="anCustCount" style="color:#a855f7;">&mdash;</div><div class="kpi-sub">Unique buyers</div></div>
          </div>

          <!-- Two-column layout: Products + Customers -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
            <!-- Revenue by Product -->
            <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;overflow:hidden;">
              <div style="padding:16px 20px;border-bottom:1px solid #1e293b;font-size:15px;font-weight:700;">Revenue by Product</div>
              <table class="inv-table">
                <thead><tr><th>Product</th><th>Units</th><th>Revenue</th></tr></thead>
                <tbody id="anProductBody"><tr><td colspan="3" class="inv-empty">No data yet</td></tr></tbody>
              </table>
            </div>
            <!-- Top Customers -->
            <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;overflow:hidden;">
              <div style="padding:16px 20px;border-bottom:1px solid #1e293b;font-size:15px;font-weight:700;">Top Customers</div>
              <table class="inv-table">
                <thead><tr><th>Customer</th><th>Orders</th><th>Total Spent</th></tr></thead>
                <tbody id="anCustBody"><tr><td colspan="3" class="inv-empty">No data yet</td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- Weekly Revenue Chart -->
          <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;padding:20px;margin-bottom:24px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
              <h3 style="font-size:15px;font-weight:700;margin:0;">Weekly Revenue ‚Äî Last 12 Weeks</h3>
            </div>
            <div id="anWeekChart" style="display:flex;align-items:flex-end;gap:6px;height:140px;"></div>
            <div id="anWeekLabels" style="display:flex;gap:6px;margin-top:6px;"></div>
          </div>

          <!-- Invoice Funnel -->
          <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;padding:20px;">
            <h3 style="font-size:15px;font-weight:700;margin:0 0 16px 0;">Invoice Funnel</h3>
            <div id="anFunnel"></div>
          </div>
        </div>

        <!-- Facebook -->
        <div class="tab-content" id="tab-facebook">
          <div class="main-title">Facebook / Comment-to-Pay</div>

          <!-- Comment-to-Pay Webhook -->
          <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;padding:24px;max-width:700px;margin-bottom:24px;">
            <h3 style="font-size:16px;font-weight:700;margin-bottom:4px;">Comment-to-Pay Webhook</h3>
            <p style="font-size:13px;color:#64748b;margin-bottom:16px;">When a customer comments on your Facebook post, your automation tool sends their info here and gets back a payment link to DM them.</p>

            <label style="display:block;font-size:13px;color:#94a3b8;margin-bottom:4px;">Webhook URL</label>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:16px;">
              <input type="text" id="ctpWebhookUrl" readonly style="flex:1;padding:10px 12px;border-radius:8px;border:1px solid #374151;background:#0a0e1a;color:#e2e8f0;font-size:13px;font-family:monospace;" />
              <button type="button" id="ctpCopyUrlBtn" style="padding:8px 14px;font-size:12px;font-weight:600;background:#1e293b;color:#e2e8f0;border:1px solid #374151;border-radius:8px;cursor:pointer;white-space:nowrap;">Copy</button>
            </div>

            <div style="background:#0a0e1a;border:1px solid #1e293b;border-radius:8px;padding:16px;font-size:13px;color:#94a3b8;line-height:1.6;margin-bottom:16px;">
              <strong style="color:#e2e8f0;">Automation Setup:</strong><br>
              1. Create an automation triggered by Facebook comment keywords (e.g. "BUY", "WANT", "ORDER").<br>
              2. Add a step to collect the buyer's email address.<br>
              3. Add an External Request (POST) to the <strong>Webhook URL</strong> above with JSON body (see example below).<br>
              4. Use the returned <code>paymentMessage</code> to send a DM to the buyer with their payment link.<br><br>
              <strong style="color:#e2e8f0;">JSON Body Example:</strong>
              <code style="display:block;background:#111827;padding:10px;border-radius:6px;margin:8px 0;font-size:12px;color:#10b981;">
{<br>
&nbsp;&nbsp;"apiKey": "YOUR_API_KEY",<br>
&nbsp;&nbsp;"buyerName": "Jane Doe",<br>
&nbsp;&nbsp;"buyerEmail": "jane@example.com",<br>
&nbsp;&nbsp;"messengerUserId": "12345",<br>
&nbsp;&nbsp;"productTitle": "Lavender Body Butter",<br>
&nbsp;&nbsp;"price": 14.99,<br>
&nbsp;&nbsp;"description": "Optional notes"<br>
}
              </code>
              <strong style="color:#e2e8f0;">Or with multiple items:</strong>
              <code style="display:block;background:#111827;padding:10px;border-radius:6px;margin:8px 0;font-size:12px;color:#10b981;">
{<br>
&nbsp;&nbsp;"apiKey": "YOUR_API_KEY",<br>
&nbsp;&nbsp;"buyerEmail": "jane@example.com",<br>
&nbsp;&nbsp;"items": [<br>
&nbsp;&nbsp;&nbsp;&nbsp;{"title": "Body Butter", "price": 14.99, "quantity": 1},<br>
&nbsp;&nbsp;&nbsp;&nbsp;{"title": "Lip Balm", "price": 5.99, "quantity": 2}<br>
&nbsp;&nbsp;]<br>
}
              </code>
              <strong style="color:#e2e8f0;">Response:</strong> <code>{ ok, invoiceId, invoiceUrl, total, paymentMessage }</code> ‚Äî use <code>paymentMessage</code> as the DM text.
            </div>

            <!-- Test Section -->
            <h4 style="font-size:14px;font-weight:600;margin-bottom:12px;color:#e2e8f0;">Test Comment-to-Pay</h4>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
              <div>
                <label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:4px;">Buyer Name</label>
                <input type="text" id="ctpTestName" placeholder="Jane Doe" style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid #374151;background:#0a0e1a;color:#e2e8f0;font-size:13px;box-sizing:border-box;" />
              </div>
              <div>
                <label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:4px;">Buyer Email *</label>
                <input type="email" id="ctpTestEmail" placeholder="jane@example.com" style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid #374151;background:#0a0e1a;color:#e2e8f0;font-size:13px;box-sizing:border-box;" />
              </div>
              <div>
                <label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:4px;">Product Title *</label>
                <input type="text" id="ctpTestProduct" placeholder="Lavender Body Butter" style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid #374151;background:#0a0e1a;color:#e2e8f0;font-size:13px;box-sizing:border-box;" />
              </div>
              <div>
                <label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:4px;">Price *</label>
                <input type="number" id="ctpTestPrice" placeholder="14.99" step="0.01" min="0" style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid #374151;background:#0a0e1a;color:#e2e8f0;font-size:13px;box-sizing:border-box;" />
              </div>
            </div>
            <button type="button" class="btn-green" id="ctpTestBtn">Send Test</button>
            <pre id="ctpTestResult" style="margin-top:12px;background:#0a0e1a;border:1px solid #1e293b;border-radius:8px;padding:12px;font-size:12px;color:#10b981;white-space:pre-wrap;display:none;"></pre>
          </div>
        </div>

        <!-- Customers -->
        <div class="tab-content" id="tab-customers">
          <div class="main-title">Customers</div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <span id="custCount" style="color:#94a3b8;font-size:14px;">0 customers</span>
            <button type="button" id="custExportBtn" class="btn-gray" style="padding:6px 16px;font-size:13px;">Export CSV</button>
          </div>
          <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;overflow:hidden;">
            <table class="inv-table">
              <thead><tr><th>Name</th><th>Email</th><th>Orders</th><th>Total Spent</th><th>Last Purchase</th></tr></thead>
              <tbody id="custTableBody">
                <tr><td colspan="5" class="inv-empty">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Marketing -->
        <div class="tab-content" id="tab-marketing">
          <div class="main-title">Marketing</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;">
            <!-- Email All Customers -->
            <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;padding:20px;">
              <div style="font-size:16px;font-weight:700;color:#e2e8f0;margin-bottom:12px;">Email All Customers</div>
              <label style="font-size:12px;color:#64748b;display:block;margin-bottom:4px;">Subject</label>
              <input type="text" id="mktSubject" placeholder="e.g. New arrivals this week!" style="width:100%;padding:8px 12px;border-radius:8px;border:1px solid #374151;background:#0a0e1a;color:#e2e8f0;font-size:14px;margin-bottom:10px;box-sizing:border-box;">
              <label style="font-size:12px;color:#64748b;display:block;margin-bottom:4px;">Message</label>
              <textarea id="mktMessage" rows="4" placeholder="Write your message..." style="width:100%;padding:8px 12px;border-radius:8px;border:1px solid #374151;background:#0a0e1a;color:#e2e8f0;font-size:14px;resize:vertical;margin-bottom:12px;box-sizing:border-box;"></textarea>
              <button type="button" id="mktSendBtn" class="btn-green" style="width:100%;padding:10px;font-size:14px;">Send to 0 customers</button>
              <div id="mktSendStatus" style="margin-top:8px;font-size:13px;color:#64748b;display:none;"></div>
            </div>
            <!-- Create Discount Code -->
            <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;padding:20px;">
              <div style="font-size:16px;font-weight:700;color:#e2e8f0;margin-bottom:12px;">Create Discount Code</div>
              <div style="color:#64748b;font-size:14px;">Coming soon</div>
            </div>
            <!-- Export Customer List -->
            <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;padding:20px;">
              <div style="font-size:16px;font-weight:700;color:#e2e8f0;margin-bottom:12px;">Export Customer List</div>
              <div style="color:#64748b;font-size:14px;margin-bottom:12px;">Download all your customers as a CSV file.</div>
              <button type="button" id="mktExportBtn" class="btn-gray" style="width:100%;padding:10px;font-size:14px;">Export CSV</button>
            </div>
          </div>
        </div>

        <!-- Settings -->
        <div class="tab-content" id="tab-settings">
          <div class="main-title">Settings</div>

          <div style="background:#1e293b;border-radius:12px;padding:20px;margin-bottom:16px;">
            <h3 style="font-size:16px;margin-bottom:8px;">üí≥ Stripe Connect</h3>
            <p style="color:#94a3b8;font-size:13px;margin-bottom:12px;">Connect your Stripe account to receive payouts from sales.</p>
            <div id="stripeConnectStatus" style="margin-bottom:12px;font-size:14px;color:#94a3b8;">Checking...</div>
            <button id="stripeConnectBtn" style="padding:10px 20px;background:#6366f1;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">Connect Stripe</button>
          </div>

          <div style="background:#1e293b;border-radius:12px;padding:20px;margin-bottom:16px;">
            <h3 style="font-size:16px;margin-bottom:8px;">üå± Regenerative Agriculture Donation</h3>
            <p style="color:#94a3b8;font-size:13px;margin-bottom:12px;">Percentage of each sale donated to Mad Agriculture (1-10%).</p>
            <div style="display:flex;align-items:center;gap:12px;">
              <input type="range" id="settRegenPct" min="1" max="10" value="1" style="flex:1;">
              <span id="regenPctDisplay" style="font-weight:700;color:#10b981;min-width:40px;">1%</span>
            </div>
          </div>

          <div style="background:#1e293b;border-radius:12px;padding:20px;margin-bottom:16px;">
            <h3 style="font-size:16px;margin-bottom:8px;">üì¶ Shipping Provider (Shippo)</h3>
            <p style="color:#94a3b8;font-size:13px;margin-bottom:12px;">Connect your Shippo account for discounted shipping labels. Free to sign up ‚Äî you only pay per label.</p>
            <label style="font-size:13px;color:#94a3b8;">Shippo API Key</label>
            <input type="text" id="settShippoKey" placeholder="shippo_live_..." style="width:100%;padding:10px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;margin:6px 0 12px;">
            <h4 style="font-size:14px;margin:12px 0 8px;">Ship From Address</h4>
            <input type="text" id="settShipName" placeholder="Name" style="width:100%;padding:8px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;margin-bottom:6px;">
            <input type="text" id="settShipStreet" placeholder="Street" style="width:100%;padding:8px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;margin-bottom:6px;">
            <div style="display:flex;gap:8px;">
              <input type="text" id="settShipCity" placeholder="City" style="flex:2;padding:8px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;">
              <input type="text" id="settShipState" placeholder="ST" style="flex:1;padding:8px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;">
              <input type="text" id="settShipZip" placeholder="ZIP" style="flex:1;padding:8px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#e2e8f0;">
            </div>
          </div>

          <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;padding:24px;max-width:480px;">
            <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">Deposit Settings</h3>
            <label style="display:block;font-size:13px;color:#94a3b8;margin-bottom:8px;">Deposit Mode</label>
            <select id="settDepositMode" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #374151;background:#0a0e1a;color:#e2e8f0;font-size:14px;margin-bottom:16px;">
              <option value="none">None ‚Äî No deposits required</option>
              <option value="standard">Standard (5%) ‚Äî 5% deposit on all orders</option>
              <option value="double">Double (10%) ‚Äî 10% deposit on all orders</option>
            </select>
            <label style="display:block;font-size:13px;color:#94a3b8;margin-bottom:4px;">Ghost Timeout (hours)</label>
            <p style="font-size:12px;color:#475569;margin-bottom:8px;">Hours before a pending deposit is auto-forfeited</p>
            <input type="number" id="settGhostHours" min="1" max="720" value="48" style="width:120px;padding:10px 12px;border-radius:8px;border:1px solid #374151;background:#0a0e1a;color:#e2e8f0;font-size:14px;margin-bottom:20px;" />
            <div>
              <button type="button" class="btn-green" id="saveSettingsBtn">Save Settings</button>
              <span id="settSaved" style="margin-left:12px;color:#10b981;font-size:13px;display:none;">Saved!</span>
            </div>
          </div>

          <!-- Facebook Auto-Sync -->
          <div style="background:#111827;border:1px solid #1e293b;border-radius:12px;padding:24px;max-width:600px;margin-top:24px;">
            <h3 style="font-size:16px;font-weight:700;margin-bottom:4px;">Facebook Auto-Sync</h3>
            <p style="font-size:13px;color:#64748b;margin-bottom:16px;">Connect your automation tool to auto-create listings from your Facebook posts.</p>

            <label style="display:block;font-size:13px;color:#94a3b8;margin-bottom:4px;">Your API Key</label>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
              <input type="text" id="fbApiKey" readonly style="flex:1;padding:10px 12px;border-radius:8px;border:1px solid #374151;background:#0a0e1a;color:#e2e8f0;font-size:13px;font-family:monospace;" value="Loading..." />
              <button type="button" id="fbCopyKeyBtn" style="padding:8px 14px;font-size:12px;font-weight:600;background:#1e293b;color:#e2e8f0;border:1px solid #374151;border-radius:8px;cursor:pointer;white-space:nowrap;">Copy</button>
              <button type="button" id="fbRegenKeyBtn" style="padding:8px 14px;font-size:12px;font-weight:600;background:#dc2626;color:#fff;border:none;border-radius:8px;cursor:pointer;white-space:nowrap;">Regenerate</button>
            </div>

            <label style="display:block;font-size:13px;color:#94a3b8;margin-bottom:4px;">Webhook URL</label>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:16px;">
              <input type="text" id="fbWebhookUrl" readonly style="flex:1;padding:10px 12px;border-radius:8px;border:1px solid #374151;background:#0a0e1a;color:#e2e8f0;font-size:13px;font-family:monospace;" />
              <button type="button" id="fbCopyUrlBtn" style="padding:8px 14px;font-size:12px;font-weight:600;background:#1e293b;color:#e2e8f0;border:1px solid #374151;border-radius:8px;cursor:pointer;white-space:nowrap;">Copy</button>
            </div>

            <h4 style="margin:16px 0 8px;font-size:14px;">How Comment-to-Pay Works</h4>
            <p style="color:#94a3b8;font-size:13px;line-height:1.6;margin-bottom:12px;">
              Someone comments on your Facebook post ‚Üí ManyChat auto-DMs them a payment link ‚Üí they pay ‚Üí you get paid. Here's how to set it up:
            </p>
            <ol style="color:#94a3b8;font-size:13px;line-height:2;padding-left:20px;margin-bottom:16px;">
              <li>Sign up at <a href="https://manychat.com" target="_blank" style="color:#6366f1;">manychat.com</a> and connect your Facebook Page</li>
              <li>Create a new <strong>Flow</strong> with trigger: <strong>Comments on a Post</strong></li>
              <li>Add an action step: <strong>External Request ‚Üí POST</strong></li>
              <li>Paste the <strong>Webhook URL</strong> from above</li>
              <li>Set Header: <code style="background:#0f172a;padding:2px 6px;border-radius:4px;">Content-Type: application/json</code></li>
              <li>Set Body to JSON (copy & edit below):</li>
            </ol>
            <pre style="background:#0f172a;padding:12px;border-radius:8px;font-size:12px;color:#e2e8f0;overflow-x:auto;margin:8px 0 16px;">{
  "apiKey": "PASTE_YOUR_API_KEY_FROM_ABOVE",
  "buyerName": "{{first_name}}",
  "buyerEmail": "{{email}}",
  "productTitle": "Your item name",
  "price": 29.99
}</pre>
            <p style="color:#94a3b8;font-size:13px;line-height:1.6;">
              <strong>{{first_name}}</strong> and <strong>{{email}}</strong> are ManyChat variables ‚Äî they auto-fill with the buyer's info from Messenger.
            </p>
            <p style="color:#64748b;font-size:12px;margin-top:12px;">
              Don't use ManyChat? You can skip this ‚Äî just create invoices manually from the Invoices tab and send payment links directly.
            </p>
          </div>
        </div>

      </main>
    </div>

    <!-- Invoice Modal -->
    <div class="inv-modal-overlay" id="invModalOverlay">
      <div class="inv-modal">
        <button class="close-btn" id="invCloseBtn">&times;</button>
        <h3>Create Invoice</h3>
        <label>Customer Email *</label>
        <input type="email" id="invEmail" placeholder="customer@example.com" />
        <label>Customer Name</label>
        <input type="text" id="invName" placeholder="Jane Doe" />
        <label>Phone</label>
        <input type="tel" id="invPhone" placeholder="(555) 123-4567" />
        <label>Line Items *</label>
        <div id="invLines"></div>
        <button class="inv-add-line" id="addLineBtn">+ Add line item</button>
        <div class="inv-totals">
          <div><span>Subtotal</span><span id="invSubtotal">$0.00</span></div>
          <div style="font-size:12px;color:#64748b;"><span>Fees deducted from payout at checkout</span></div>
          <div class="inv-total-row"><span>Total</span><span id="invTotal">$0.00</span></div>
        </div>
        <label>Notes</label>
        <textarea id="invNotes" placeholder="Optional notes for the customer..."></textarea>
        <label>Due Date</label>
        <input type="date" id="invDueDate" />
        <div class="inv-modal-actions">
          <button class="btn-gray" id="invCancelBtn">Cancel</button>
          <button class="btn-green" id="invSubmitBtn">Create Draft</button>
        </div>
      </div>
    </div>

    <script>
    (function(){
      var place = window.SELLER_PLACE;
      if(!place){ window.location.href = "/login"; return; }

      // Set store name
      document.getElementById("sidebarStoreName").textContent = place.name;
      document.getElementById("mobileStoreName").textContent = place.name;

      // Tab switching
      var navLinks = document.querySelectorAll("#sidebarNav a");
      var tabs = document.querySelectorAll(".tab-content");

      function switchTab(tabId){
        tabs.forEach(function(t){ t.classList.remove("active"); });
        navLinks.forEach(function(a){ a.classList.remove("active"); });
        var target = document.getElementById("tab-" + tabId);
        if(target) target.classList.add("active");
        var link = document.querySelector('#sidebarNav a[data-tab="' + tabId + '"]');
        if(link) link.classList.add("active");
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("overlay").classList.remove("open");
      }

      navLinks.forEach(function(a){
        a.addEventListener("click", function(e){
          e.preventDefault();
          var tab = this.getAttribute("data-tab");
          switchTab(tab);
          history.replaceState(null, "", "#" + tab);
        });
      });

      // Handle hash on load
      var hash = window.location.hash.replace("#","");
      if(hash && document.getElementById("tab-" + hash)){
        switchTab(hash);
      }

      // Mobile toggle
      document.getElementById("menuToggle").addEventListener("click", function(){
        document.getElementById("sidebar").classList.toggle("open");
        document.getElementById("overlay").classList.toggle("open");
      });
      document.getElementById("overlay").addEventListener("click", function(){
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("overlay").classList.remove("open");
      });

      /* ‚îÄ‚îÄ‚îÄ Overview / Dashboard Stats ‚îÄ‚îÄ‚îÄ */
      async function loadDashboardStats(){
        try {
          var resp = await fetch("/api/seller/dashboard-stats");
          if(!resp.ok) return;
          var s = await resp.json();
          document.getElementById("kpiTodayRev").textContent = "$" + (s.todayRevenue||0).toFixed(2);
          document.getElementById("kpiTodayOrd").textContent = s.todayOrders || "0";
          document.getElementById("kpiTodayOrders").textContent = s.todayOrders + " order" + (s.todayOrders !== 1 ? "s" : "") + " today";
          document.getElementById("kpiTotalRev").textContent = "$" + (s.totalRevenue||0).toFixed(2);
          document.getElementById("kpiTotalOrders").textContent = s.totalOrders + " order" + (s.totalOrders !== 1 ? "s" : "") + " all time";
          document.getElementById("kpiOutstanding").textContent = "$" + (s.outstandingInvoices||0).toFixed(2);
          document.getElementById("kpiDeposits").textContent = "$" + (s.pendingDeposits||0).toFixed(2);
          document.getElementById("kpiDepCount").textContent = s.pendingDepositCount + " pending";
          document.getElementById("sidebarMonthlyRev").textContent = "$" + (s.monthlyRevenue||0).toFixed(2);
          document.getElementById("chartTotal").textContent = "Total: $" + (s.totalRevenue||0).toFixed(2);

          // Build 30-day bar chart
          var chart = document.getElementById("revChart");
          var labels = document.getElementById("revChartLabels");
          var days = s.revenueByDay || [];
          // Fill in all 30 days
          var dayMap = {};
          days.forEach(function(d){ dayMap[d.day ? d.day.substring(0,10) : ""] = d.revenue; });
          var bars = [];
          for(var i = 29; i >= 0; i--){
            var dt = new Date(); dt.setDate(dt.getDate() - i);
            var key = dt.toISOString().substring(0,10);
            bars.push({ day: key, revenue: dayMap[key] || 0, label: dt.getDate() });
          }
          var maxRev = Math.max.apply(null, bars.map(function(b){ return b.revenue; })) || 1;
          chart.innerHTML = bars.map(function(b){
            var pct = Math.max((b.revenue / maxRev) * 100, 2);
            var color = b.revenue > 0 ? "#10b981" : "#1e293b";
            var title = b.day + ": $" + b.revenue.toFixed(2);
            return '<div title="' + title + '" class="rev-bar" style="flex:1;min-width:0;height:' + pct + '%;background:' + color + ';border-radius:3px 3px 0 0;cursor:pointer;"></div>';
          }).join("");
          labels.innerHTML = bars.map(function(b, idx){
            var show = idx === 0 || idx === 14 || idx === 29;
            return '<div style="flex:1;min-width:0;text-align:center;font-size:10px;color:' + (show ? '#64748b' : 'transparent') + ';">' + b.label + '</div>';
          }).join("");
        } catch(err){ console.error("LOAD_DASHBOARD_STATS_ERROR", err); }
      }

      // Load overview immediately since it's the default active tab
      loadDashboardStats();

      /* ‚îÄ‚îÄ‚îÄ Invoice helpers ‚îÄ‚îÄ‚îÄ */
      function fmt(n){ return "$" + (Number(n)||0).toFixed(2); }

      function calcInvTotals(){
        var rows = document.querySelectorAll("#invLines .inv-line-row");
        var sub = 0;
        rows.forEach(function(r){
          var q = Number(r.querySelector(".line-qty").value) || 0;
          var p = Number(r.querySelector(".line-price").value) || 0;
          sub += q * p;
        });
        document.getElementById("invSubtotal").textContent = fmt(sub);
        document.getElementById("invTotal").textContent = fmt(sub);
      }

      function addInvLine(){
        var wrap = document.getElementById("invLines");
        var row = document.createElement("div");
        row.className = "inv-line-row";
        row.innerHTML = '<input type="text" placeholder="Item name" class="line-title" />'
          + '<input type="number" min="1" value="1" class="qty-input line-qty" />'
          + '<input type="number" step="0.01" min="0" placeholder="Price" class="price-input line-price" />'
          + '<button type="button" class="remove-line">&times;</button>';
        wrap.appendChild(row);
        row.querySelector(".line-qty").addEventListener("input", calcInvTotals);
        row.querySelector(".line-price").addEventListener("input", calcInvTotals);
      }

      function openInvModal(){
        document.getElementById("invEmail").value = "";
        document.getElementById("invName").value = "";
        document.getElementById("invPhone").value = "";
        document.getElementById("invNotes").value = "";
        document.getElementById("invDueDate").value = "";
        document.getElementById("invLines").innerHTML = "";
        addInvLine();
        calcInvTotals();
        document.getElementById("invSubmitBtn").disabled = false;
        document.getElementById("invSubmitBtn").textContent = "Create Draft";
        document.getElementById("invModalOverlay").style.display = "flex";
      }

      function closeInvModal(){
        document.getElementById("invModalOverlay").style.display = "none";
      }

      function badgeHtml(status){
        var colors = { draft: "#374151", sent: "#2563eb", paid: "#10b981", cancelled: "#ef4444" };
        var bg = colors[status] || "#374151";
        return '<span class="inv-badge" style="background:' + bg + ';color:#fff;">' + (status||"draft") + '</span>';
      }

      async function submitInvoice(){
        var btn = document.getElementById("invSubmitBtn");
        btn.disabled = true; btn.textContent = "Saving...";
        var rows = document.querySelectorAll("#invLines .inv-line-row");
        var items = [];
        rows.forEach(function(r){
          var title = r.querySelector(".line-title").value.trim();
          var qty = Number(r.querySelector(".line-qty").value) || 1;
          var price = Number(r.querySelector(".line-price").value) || 0;
          if(title) items.push({ title: title, quantity: qty, unitPrice: price });
        });
        if(!items.length){ alert("Add at least one line item"); btn.disabled = false; btn.textContent = "Create Draft"; return; }
        var email = document.getElementById("invEmail").value.trim();
        if(!email){ alert("Customer email is required"); btn.disabled = false; btn.textContent = "Create Draft"; return; }
        try {
          var resp = await fetch("/api/seller/invoices", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              buyerEmail: email,
              buyerName: document.getElementById("invName").value.trim(),
              buyerPhone: document.getElementById("invPhone").value.trim(),
              items: items,
              notes: document.getElementById("invNotes").value.trim(),
              dueDate: document.getElementById("invDueDate").value || null
            })
          });
          if(!resp.ok) throw new Error((await resp.json()).error || "Failed");
          closeInvModal();
          loadInvoices();
        } catch(err){
          alert("Error: " + err.message);
        }
        btn.disabled = false; btn.textContent = "Create Draft";
      }

      async function sendInvoice(id){
        if(!confirm("Mark this invoice as sent?")) return;
        try {
          var resp = await fetch("/api/seller/invoices/" + id + "/send", { method: "PUT" });
          if(!resp.ok) throw new Error("Failed");
          loadInvoices();
        } catch(err){ alert("Error: " + err.message); }
      }

      async function loadInvoices(){
        try {
          var resp = await fetch("/api/seller/invoices");
          if(!resp.ok) return;
          var rows = await resp.json();
          var body = document.getElementById("invTableBody");
          var collected = 0, outstanding = 0, fees = 0;
          rows.forEach(function(inv){
            var t = Number(inv.total) || 0;
            var f = Number(inv.platform_fee || inv.platformfee || inv.platformFee) || 0;
            if(inv.status === "paid"){ collected += t; fees += f; }
            if(inv.status === "sent" || inv.status === "draft") outstanding += t;
          });
          document.getElementById("invCollected").textContent = fmt(collected);
          document.getElementById("invOutstanding").textContent = fmt(outstanding);
          document.getElementById("invFees").textContent = fmt(fees);
          document.getElementById("invCount").textContent = rows.length + " invoice" + (rows.length !== 1 ? "s" : "");
          if(!rows.length){
            body.innerHTML = '<tr><td colspan="6" class="inv-empty">No invoices yet ‚Äî create your first one!</td></tr>';
            return;
          }
          body.innerHTML = rows.map(function(inv){
            var date = inv.created_at || inv.createdat || inv.createdAt || "";
            if(date) date = new Date(date).toLocaleDateString();
            var name = inv.buyer_name || inv.buyername || inv.buyerName || inv.buyer_email || inv.buyeremail || inv.buyerEmail || "";
            var actions = inv.status === "draft" ? '<button type="button" class="btn-green inv-send-btn" data-id="' + inv.id + '" style="padding:4px 12px;font-size:12px;">Send</button>' : "";
            return '<tr>'
              + '<td>#' + inv.id + '</td>'
              + '<td>' + name + '</td>'
              + '<td>' + fmt(inv.total) + '</td>'
              + '<td>' + badgeHtml(inv.status) + '</td>'
              + '<td style="color:#64748b;">' + date + '</td>'
              + '<td>' + actions + '</td>'
              + '</tr>';
          }).join("");
        } catch(err){ console.error("LOAD_INVOICES_ERROR", err); }
      }

      /* ‚îÄ‚îÄ‚îÄ Bind all events via addEventListener ‚îÄ‚îÄ‚îÄ */

      // New Invoice button
      document.getElementById("newInvBtn").addEventListener("click", openInvModal);

      // Modal overlay click-to-close (only when clicking backdrop, not modal itself)
      document.getElementById("invModalOverlay").addEventListener("click", function(e){
        if(e.target === this) closeInvModal();
      });

      // Modal close button
      document.getElementById("invCloseBtn").addEventListener("click", closeInvModal);

      // Modal cancel button
      document.getElementById("invCancelBtn").addEventListener("click", closeInvModal);

      // Modal submit button
      document.getElementById("invSubmitBtn").addEventListener("click", submitInvoice);

      // Add line item button
      document.getElementById("addLineBtn").addEventListener("click", addInvLine);

      // Event delegation: remove line item buttons (dynamically created)
      document.getElementById("invLines").addEventListener("click", function(e){
        var btn = e.target.closest(".remove-line");
        if(btn){
          btn.parentElement.remove();
          calcInvTotals();
        }
      });

      // Event delegation: send invoice buttons (dynamically created in table)
      document.getElementById("invTableBody").addEventListener("click", function(e){
        var btn = e.target.closest(".inv-send-btn");
        if(btn){
          var id = Number(btn.getAttribute("data-id"));
          if(id) sendInvoice(id);
        }
      });

      /* ‚îÄ‚îÄ‚îÄ Settings logic ‚îÄ‚îÄ‚îÄ */
      async function loadSettings(){
        try {
          var resp = await fetch("/api/seller/settings");
          if(!resp.ok) return;
          var s = await resp.json();
          document.getElementById("settDepositMode").value = s.depositMode || "none";
          document.getElementById("settGhostHours").value = s.ghostTimeoutHours || 48;
          document.getElementById("settRegenPct").value = s.regenPct || 1;
          document.getElementById("regenPctDisplay").textContent = (s.regenPct || 1) + "%";
          document.getElementById("settShippoKey").value = s.shippoApiKey || "";
          document.getElementById("settShipName").value = s.shipFromName || "";
          document.getElementById("settShipStreet").value = s.shipFromStreet || "";
          document.getElementById("settShipCity").value = s.shipFromCity || "";
          document.getElementById("settShipState").value = s.shipFromState || "";
          document.getElementById("settShipZip").value = s.shipFromZip || "";
        } catch(err){ console.error("LOAD_SETTINGS_ERROR", err); }
      }

      async function saveSettings(){
        var btn = document.getElementById("saveSettingsBtn");
        btn.disabled = true; btn.textContent = "Saving...";
        try {
          var resp = await fetch("/api/seller/settings", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              depositMode: document.getElementById("settDepositMode").value,
              ghostTimeoutHours: Number(document.getElementById("settGhostHours").value) || 48,
              regenPct: Number(document.getElementById("settRegenPct").value),
              shippoApiKey: document.getElementById("settShippoKey").value,
              shipFromName: document.getElementById("settShipName").value,
              shipFromStreet: document.getElementById("settShipStreet").value,
              shipFromCity: document.getElementById("settShipCity").value,
              shipFromState: document.getElementById("settShipState").value,
              shipFromZip: document.getElementById("settShipZip").value
            })
          });
          if(!resp.ok) throw new Error((await resp.json()).error || "Failed");
          var saved = document.getElementById("settSaved");
          saved.style.display = "inline";
          setTimeout(function(){ saved.style.display = "none"; }, 2500);
        } catch(err){ alert("Error: " + err.message); }
        btn.disabled = false; btn.textContent = "Save Settings";
      }

      document.getElementById("saveSettingsBtn").addEventListener("click", saveSettings);

      // Regen slider
      document.getElementById("settRegenPct").addEventListener("input", function(){
        document.getElementById("regenPctDisplay").textContent = this.value + "%";
      });

      // Stripe Connect
      async function connectStripe(){
        try {
          var r = await fetch("/api/seller/stripe-connect", { method: "POST" });
          var d = await r.json();
          if(d.url) window.location.href = d.url;
          else alert(d.error || "Error connecting Stripe");
        } catch(err){ alert("Error: " + err.message); }
      }
      window.connectStripe = connectStripe;
      document.getElementById("stripeConnectBtn").addEventListener("click", connectStripe);

      async function loadStripeStatus(){
        try {
          var r = await fetch("/api/seller/stripe-connect/status");
          var d = await r.json();
          var el = document.getElementById("stripeConnectStatus");
          var btn = document.getElementById("stripeConnectBtn");
          if(d.complete){ el.innerHTML = '<span style="color:#10b981;font-weight:600;">‚úì Connected</span> ‚Äî Payouts enabled'; btn.textContent = "Manage Stripe"; }
          else if(d.connected){ el.innerHTML = '<span style="color:#f59e0b;">‚ö† Onboarding incomplete</span>'; btn.textContent = "Complete Setup"; }
          else { el.textContent = "Not connected"; btn.textContent = "Connect Stripe"; }
        } catch(err){ console.error(err); }
      }

      // Deposit creation
      document.getElementById("depTotalPrice").addEventListener("input", function(){
        var v = Number(this.value);
        var preview = document.getElementById("depPreview");
        if(v >= 20){ preview.style.display = "block"; preview.textContent = "Deposit: $" + (v * 0.05).toFixed(2) + " (5%)"; }
        else { preview.style.display = "none"; }
      });

      document.getElementById("createDepositBtn").addEventListener("click", async function(){
        var name = document.getElementById("depBuyerName").value.trim();
        var total = Number(document.getElementById("depTotalPrice").value);
        if(!name || !total){ alert("Buyer name and total price are required"); return; }
        try {
          var r = await fetch("/api/seller/deposits/create", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ buyerName: name, buyerEmail: document.getElementById("depBuyerEmail").value.trim(), description: document.getElementById("depDescription").value.trim(), totalPrice: total }) });
          var d = await r.json();
          if(!d.ok){ alert(d.error || "Error"); return; }
          document.getElementById("depLink").value = d.depositUrl;
          document.getElementById("depResult").style.display = "block";
          navigator.clipboard.writeText(d.depositUrl);
          document.getElementById("depBuyerName").value = "";
          document.getElementById("depBuyerEmail").value = "";
          document.getElementById("depDescription").value = "";
          document.getElementById("depTotalPrice").value = "";
          document.getElementById("depPreview").style.display = "none";
          loadCashDeposits();
        } catch(err){ alert("Error: " + err.message); }
      });

      document.getElementById("copyDepLink").addEventListener("click", function(){
        navigator.clipboard.writeText(document.getElementById("depLink").value);
        this.textContent = "Copied!"; setTimeout(function(){ document.getElementById("copyDepLink").textContent = "Copy Link"; }, 2000);
      });

      async function loadCashDeposits(){
        try {
          var r = await fetch("/api/seller/deposits/list");
          var deps = await r.json();
          document.getElementById("cashDepositsBody").innerHTML = deps.map(function(d){
            var date = new Date(d.created_at).toLocaleDateString();
            var sc = d.status === "collected" ? "#10b981" : d.status === "forfeited" ? "#ef4444" : "#f59e0b";
            var actions = "";
            if(d.status === "pending") actions = '<button onclick="forfeitCashDeposit('+d.id+')" style="padding:4px 10px;border:none;border-radius:6px;background:#ef4444;color:#fff;font-size:11px;cursor:pointer;">Forfeit</button>';
            if(d.status === "collected") actions = '<button onclick="refundCashDeposit('+d.id+')" style="padding:4px 10px;border:none;border-radius:6px;background:#64748b;color:#fff;font-size:11px;cursor:pointer;">Refund</button>';
            return '<tr><td style="padding:6px;">'+date+'</td><td>'+(d.buyer_name||d.buyer_email||"‚Äî")+'</td><td>'+(d.description||"‚Äî")+'</td><td>$'+(Number(d.total_price)||0).toFixed(2)+'</td><td>$'+Number(d.amount).toFixed(2)+'</td><td><span style="color:'+sc+';font-weight:600;">'+d.status+'</span></td><td>'+actions+'</td></tr>';
          }).join("");
        } catch(err){ console.error("LOAD_CASH_DEPOSITS_ERROR", err); }
      }

      window.forfeitCashDeposit = async function(id){
        if(!confirm("Forfeit this deposit?")) return;
        await fetch("/api/deposits/" + id + "/forfeit", { method: "PUT" });
        loadCashDeposits();
      };

      window.refundCashDeposit = async function(id){
        if(!confirm("Refund this deposit?")) return;
        await fetch("/api/deposits/" + id + "/refund", { method: "PUT" });
        loadCashDeposits();
      };

      /* ‚îÄ‚îÄ‚îÄ Analytics logic ‚îÄ‚îÄ‚îÄ */
      async function loadAnalytics(){
        try {
          var resp = await fetch("/api/seller/analytics");
          if(!resp.ok) return;
          var a = await resp.json();

          // Metric cards
          document.getElementById("anAvgOrder").textContent = "$" + (a.averageOrderValue || 0).toFixed(2);
          var conv = a.invoiceConversion || {};
          var totalInv = (conv.draft||0) + (conv.sent||0) + (conv.paid||0) + (conv.cancelled||0);
          var convPct = totalInv > 0 ? ((conv.paid / totalInv) * 100).toFixed(1) : "0.0";
          document.getElementById("anConvRate").textContent = convPct + "%";
          document.getElementById("anConvSub").textContent = conv.paid + " paid / " + totalInv + " total";
          var custCount = (a.topCustomers || []).length;
          document.getElementById("anCustCount").textContent = custCount;

          // Revenue by Product table
          var prodBody = document.getElementById("anProductBody");
          var prods = a.revenueByProduct || [];
          if(!prods.length){
            prodBody.innerHTML = '<tr><td colspan="3" class="inv-empty">No product data yet</td></tr>';
          } else {
            prodBody.innerHTML = prods.map(function(p){
              return '<tr><td>' + p.title + '</td><td>' + p.units + '</td><td style="color:#10b981;font-weight:600;">$' + p.revenue.toFixed(2) + '</td></tr>';
            }).join("");
          }

          // Top Customers table
          var custBody = document.getElementById("anCustBody");
          var custs = a.topCustomers || [];
          if(!custs.length){
            custBody.innerHTML = '<tr><td colspan="3" class="inv-empty">No customer data yet</td></tr>';
          } else {
            custBody.innerHTML = custs.map(function(c){
              var display = c.name || c.email || "‚Äî";
              return '<tr><td>' + display + '</td><td>' + c.orderCount + '</td><td style="color:#10b981;font-weight:600;">$' + c.totalSpent.toFixed(2) + '</td></tr>';
            }).join("");
          }

          // Weekly Revenue chart ‚Äî always show 12 bars
          var weekChart = document.getElementById("anWeekChart");
          var weekLabels = document.getElementById("anWeekLabels");
          var weeks = a.revenueByWeek || [];
          var weekMap = {};
          weeks.forEach(function(w){ weekMap[w.week ? w.week.substring(0,10) : ""] = w; });
          var weekBars = [];
          for(var wi = 11; wi >= 0; wi--){
            var wd = new Date(); wd.setDate(wd.getDate() - wi * 7);
            var dayOfWeek = wd.getDay();
            wd.setDate(wd.getDate() - dayOfWeek); // roll back to Monday (week start)
            var wKey = wd.toISOString().substring(0,10);
            var wData = weekMap[wKey] || null;
            weekBars.push({ day: wKey, revenue: wData ? wData.revenue : 0, orders: wData ? wData.orders : 0, label: (wd.getMonth()+1) + "/" + wd.getDate() });
          }
          var maxW = Math.max.apply(null, weekBars.map(function(b){ return b.revenue; })) || 1;
          weekChart.innerHTML = weekBars.map(function(b){
            var pct = Math.max((b.revenue / maxW) * 100, 2);
            var color = b.revenue > 0 ? "#3b82f6" : "#1e293b";
            var title = "Week of " + b.label + ": $" + b.revenue.toFixed(2) + " (" + b.orders + " orders)";
            return '<div title="' + title + '" class="rev-bar" style="flex:1;min-width:0;height:' + pct + '%;background:' + color + ';border-radius:3px 3px 0 0;cursor:pointer;"></div>';
          }).join("");
          weekLabels.innerHTML = weekBars.map(function(b){
            return '<div style="flex:1;min-width:0;text-align:center;font-size:10px;color:#64748b;">' + b.label + '</div>';
          }).join("");

          // Invoice Funnel
          var funnel = document.getElementById("anFunnel");
          var stages = [
            { label: "Draft", count: conv.draft || 0, color: "#374151" },
            { label: "Sent", count: conv.sent || 0, color: "#2563eb" },
            { label: "Paid", count: conv.paid || 0, color: "#10b981" },
            { label: "Cancelled", count: conv.cancelled || 0, color: "#ef4444" }
          ];
          var maxStage = Math.max.apply(null, stages.map(function(s){ return s.count; })) || 1;
          funnel.innerHTML = stages.map(function(s){
            var pct = totalInv > 0 ? ((s.count / totalInv) * 100).toFixed(1) : "0.0";
            var barW = Math.max((s.count / maxStage) * 100, 2);
            return '<div style="margin-bottom:10px;">'
              + '<div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px;">'
              + '<span style="color:#e2e8f0;font-weight:600;">' + s.label + '</span>'
              + '<span style="color:#94a3b8;">' + s.count + ' (' + pct + '%)</span>'
              + '</div>'
              + '<div style="height:24px;background:#0a0e1a;border-radius:6px;overflow:hidden;">'
              + '<div style="height:100%;width:' + barW + '%;background:' + s.color + ';border-radius:6px;transition:width .3s;"></div>'
              + '</div></div>';
          }).join("");

        } catch(err){ console.error("LOAD_ANALYTICS_ERROR", err); }
      }

      /* ‚îÄ‚îÄ‚îÄ Comment-to-Pay logic ‚îÄ‚îÄ‚îÄ */
      function loadCtpWebhookUrl(){
        document.getElementById("ctpWebhookUrl").value = window.location.origin + "/api/webhooks/comment-to-pay";
      }

      document.getElementById("ctpCopyUrlBtn").addEventListener("click", function(){
        var inp = document.getElementById("ctpWebhookUrl");
        navigator.clipboard.writeText(inp.value).then(function(){
          var btn = document.getElementById("ctpCopyUrlBtn");
          btn.textContent = "Copied!";
          setTimeout(function(){ btn.textContent = "Copy"; }, 1500);
        });
      });

      document.getElementById("ctpTestBtn").addEventListener("click", async function(){
        var btn = document.getElementById("ctpTestBtn");
        var result = document.getElementById("ctpTestResult");
        var email = document.getElementById("ctpTestEmail").value.trim();
        var product = document.getElementById("ctpTestProduct").value.trim();
        var price = Number(document.getElementById("ctpTestPrice").value) || 0;
        if(!email || !product){ alert("Email and Product Title are required."); return; }
        btn.disabled = true; btn.textContent = "Sending...";
        result.style.display = "none";
        try {
          var keyResp = await fetch("/api/seller/facebook-key");
          if(!keyResp.ok) throw new Error("Could not load API key");
          var keyData = await keyResp.json();
          var resp = await fetch("/api/webhooks/comment-to-pay", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              apiKey: keyData.apiKey,
              buyerName: document.getElementById("ctpTestName").value.trim() || "Test Buyer",
              buyerEmail: email,
              productTitle: product,
              price: price
            })
          });
          var d = await resp.json();
          result.style.display = "block";
          if(resp.ok){
            result.style.color = "#10b981";
            result.textContent = JSON.stringify(d, null, 2);
          } else {
            result.style.color = "#ef4444";
            result.textContent = "Error: " + (d.error || "Unknown error");
          }
        } catch(err){
          result.style.display = "block";
          result.style.color = "#ef4444";
          result.textContent = "Error: " + err.message;
        }
        btn.disabled = false; btn.textContent = "Send Test";
      });

      /* ‚îÄ‚îÄ‚îÄ Facebook Auto-Sync logic ‚îÄ‚îÄ‚îÄ */
      async function loadFacebookKey(){
        try {
          var resp = await fetch("/api/seller/facebook-key");
          if(!resp.ok) return;
          var d = await resp.json();
          document.getElementById("fbApiKey").value = d.apiKey || "";
          document.getElementById("fbWebhookUrl").value = window.location.origin + "/api/webhooks/facebook-listing";
        } catch(err){ console.error("FB_KEY_LOAD_ERROR", err); }
      }

      document.getElementById("fbCopyKeyBtn").addEventListener("click", function(){
        var inp = document.getElementById("fbApiKey");
        navigator.clipboard.writeText(inp.value).then(function(){
          var btn = document.getElementById("fbCopyKeyBtn");
          btn.textContent = "Copied!";
          setTimeout(function(){ btn.textContent = "Copy"; }, 1500);
        });
      });

      document.getElementById("fbCopyUrlBtn").addEventListener("click", function(){
        var inp = document.getElementById("fbWebhookUrl");
        navigator.clipboard.writeText(inp.value).then(function(){
          var btn = document.getElementById("fbCopyUrlBtn");
          btn.textContent = "Copied!";
          setTimeout(function(){ btn.textContent = "Copy"; }, 1500);
        });
      });

      document.getElementById("fbRegenKeyBtn").addEventListener("click", async function(){
        if(!confirm("Regenerate your Facebook API key? The old key will stop working immediately.")) return;
        var btn = document.getElementById("fbRegenKeyBtn");
        btn.disabled = true; btn.textContent = "Regenerating...";
        try {
          var resp = await fetch("/api/seller/facebook-key/regenerate", { method: "PUT" });
          if(!resp.ok) throw new Error("Failed");
          var d = await resp.json();
          document.getElementById("fbApiKey").value = d.apiKey || "";
        } catch(err){ alert("Error: " + err.message); }
        btn.disabled = false; btn.textContent = "Regenerate";
      });

      /* ‚îÄ‚îÄ‚îÄ Deposits logic ‚îÄ‚îÄ‚îÄ */
      function depBadge(status){
        var colors = { pending: "#eab308", collected: "#10b981", forfeited: "#ef4444", refunded: "#3b82f6" };
        var bg = colors[status] || "#374151";
        return '<span class="inv-badge" style="background:' + bg + ';color:#fff;">' + (status || "pending") + '</span>';
      }

      async function loadDeposits(){
        try {
          var resp = await fetch("/api/seller/deposits");
          if(!resp.ok) return;
          var rows = await resp.json();
          var body = document.getElementById("depTableBody");
          document.getElementById("depCount").textContent = rows.length + " deposit" + (rows.length !== 1 ? "s" : "");
          if(!rows.length){
            body.innerHTML = '<tr><td colspan="7" class="inv-empty">No deposits yet</td></tr>';
            return;
          }
          body.innerHTML = rows.map(function(d){
            var exp = d.expires_at || d.expiresat || d.expiresAt || "";
            if(exp) exp = new Date(exp).toLocaleString();
            var email = d.buyer_email || d.buyeremail || d.buyerEmail || "";
            var st = d.status || "pending";
            var actions = "";
            if(st === "pending") actions = '<button type="button" class="dep-forfeit-btn" data-id="' + d.id + '" style="padding:3px 10px;font-size:12px;font-weight:600;background:#ef4444;color:#fff;border:none;border-radius:6px;cursor:pointer;">Forfeit</button>';
            if(st === "collected") actions = '<button type="button" class="dep-refund-btn" data-id="' + d.id + '" style="padding:3px 10px;font-size:12px;font-weight:600;background:#3b82f6;color:#fff;border:none;border-radius:6px;cursor:pointer;">Refund</button>';
            return '<tr>'
              + '<td>#' + (d.order_id || d.orderid || d.orderId || "") + '</td>'
              + '<td>' + email + '</td>'
              + '<td>' + fmt(d.amount) + '</td>'
              + '<td>' + (d.deposit_percent || d.depositpercent || d.depositPercent || 5) + '%</td>'
              + '<td>' + depBadge(st) + '</td>'
              + '<td style="color:#64748b;font-size:12px;">' + exp + '</td>'
              + '<td>' + actions + '</td>'
              + '</tr>';
          }).join("");
        } catch(err){ console.error("LOAD_DEPOSITS_ERROR", err); }
      }

      async function forfeitDeposit(id){
        if(!confirm("Forfeit this deposit? This cannot be undone.")) return;
        try {
          var resp = await fetch("/api/deposits/" + id + "/forfeit", { method: "PUT" });
          if(!resp.ok) throw new Error("Failed");
          loadDeposits();
        } catch(err){ alert("Error: " + err.message); }
      }

      async function refundDeposit(id){
        if(!confirm("Refund this deposit?")) return;
        try {
          var resp = await fetch("/api/deposits/" + id + "/refund", { method: "PUT" });
          if(!resp.ok) throw new Error("Failed");
          loadDeposits();
        } catch(err){ alert("Error: " + err.message); }
      }

      // Event delegation for deposit action buttons
      document.getElementById("depTableBody").addEventListener("click", function(e){
        var fb = e.target.closest(".dep-forfeit-btn");
        if(fb){ forfeitDeposit(Number(fb.getAttribute("data-id"))); return; }
        var rb = e.target.closest(".dep-refund-btn");
        if(rb){ refundDeposit(Number(rb.getAttribute("data-id"))); return; }
      });

      /* ‚îÄ‚îÄ‚îÄ Tab auto-load observers ‚îÄ‚îÄ‚îÄ */
      function watchTab(tabId, loadFn){
        if(window.location.hash === "#" + tabId) loadFn();
        var loaded = window.location.hash === "#" + tabId;
        var obs = new MutationObserver(function(){
          var el = document.getElementById("tab-" + tabId);
          if(el && el.classList.contains("active")){
            if(!loaded){ loaded = true; loadFn(); }
          } else { loaded = false; }
        });
        obs.observe(document.getElementById("tab-" + tabId), { attributes: true, attributeFilter: ["class"] });
      }

      /* ‚îÄ‚îÄ‚îÄ Products tab ‚îÄ‚îÄ‚îÄ */
      async function loadProducts(){
        try {
          var resp = await fetch("/api/seller/listings");
          if(!resp.ok) return;
          var rows = await resp.json();
          document.getElementById("prodCount").textContent = rows.length + " product" + (rows.length !== 1 ? "s" : "");
          var body = document.getElementById("prodTableBody");
          if(!rows.length){
            body.innerHTML = '<tr><td colspan="6" class="inv-empty">No products yet. Add listings from your store page or use the Facebook Auto-Sync webhook.</td></tr>';
            return;
          }
          body.innerHTML = rows.map(function(p){
            var photos = [];
            try { photos = typeof p.photourlsjson === "string" ? JSON.parse(p.photourlsjson) : (p.photourlsjson || []); } catch(e){}
            var thumb = photos.length ? '<img src="' + photos[0] + '" style="width:40px;height:40px;object-fit:cover;border-radius:6px;">' : '<div style="width:40px;height:40px;border-radius:6px;background:#1e293b;"></div>';
            var sBg = p.status === "active" ? "#10b981" : "#374151";
            return '<tr>'
              + '<td>' + thumb + '</td>'
              + '<td style="color:#e2e8f0;">' + (p.title || "") + '</td>'
              + '<td>$' + (Number(p.price) || 0).toFixed(2) + '</td>'
              + '<td>' + (p.quantity || 0) + '</td>'
              + '<td><span class="inv-badge" style="background:' + sBg + ';color:#fff;">' + (p.status || "inactive") + '</span></td>'
              + '<td><button type="button" class="btn-gray prod-edit-btn" data-id="' + p.id + '" data-title="' + (p.title || "").replace(/"/g, "&quot;") + '" data-price="' + (p.price || 0) + '" data-qty="' + (p.quantity || 0) + '" data-status="' + (p.status || "inactive") + '" style="padding:4px 12px;font-size:12px;">Edit</button></td>'
              + '</tr>';
          }).join("");
        } catch(err){ console.error("LOAD_PRODUCTS_ERROR", err); }
      }

      document.getElementById("prodRefreshBtn").addEventListener("click", loadProducts);

      document.getElementById("prodGrid").addEventListener("click", function(e){
        var btn = e.target.closest(".prod-edit-btn");
        if(!btn) return;
        document.getElementById("prodEditId").value = btn.getAttribute("data-id");
        document.getElementById("prodEditTitle").value = btn.getAttribute("data-title");
        document.getElementById("prodEditPrice").value = btn.getAttribute("data-price");
        document.getElementById("prodEditQty").value = btn.getAttribute("data-qty");
        var st = btn.getAttribute("data-status") || "inactive";
        var tog = document.getElementById("prodStatusToggle");
        tog.textContent = st;
        tog.style.background = st === "active" ? "#10b981" : "#374151";
        document.getElementById("prodEditOverlay").style.display = "flex";
      });

      document.getElementById("prodStatusToggle").addEventListener("click", function(){
        var tog = document.getElementById("prodStatusToggle");
        var next = tog.textContent === "active" ? "inactive" : "active";
        tog.textContent = next;
        tog.style.background = next === "active" ? "#10b981" : "#374151";
      });

      document.getElementById("prodEditCancel").addEventListener("click", function(){
        document.getElementById("prodEditOverlay").style.display = "none";
      });

      document.getElementById("prodEditOverlay").addEventListener("click", function(e){
        if(e.target === this) this.style.display = "none";
      });

      document.getElementById("prodEditSave").addEventListener("click", async function(){
        var id = document.getElementById("prodEditId").value;
        var payload = {
          title: document.getElementById("prodEditTitle").value,
          price: Number(document.getElementById("prodEditPrice").value),
          quantity: Number(document.getElementById("prodEditQty").value),
          status: document.getElementById("prodStatusToggle").textContent
        };
        try {
          var resp = await fetch("/api/seller/listings/" + id, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if(!resp.ok){ alert("Save failed"); return; }
          document.getElementById("prodEditOverlay").style.display = "none";
          loadProducts();
        } catch(err){ console.error("SAVE_PRODUCT_ERROR", err); alert("Save failed"); }
      });

      /* ‚îÄ‚îÄ‚îÄ Customers tab ‚îÄ‚îÄ‚îÄ */
      var _custRows = [];
      async function loadCustomers(){
        try {
          var resp = await fetch("/api/seller/customers");
          if(!resp.ok) return;
          _custRows = await resp.json();
          document.getElementById("custCount").textContent = _custRows.length + " customer" + (_custRows.length !== 1 ? "s" : "");
          var body = document.getElementById("custTableBody");
          if(!_custRows.length){
            body.innerHTML = '<tr><td colspan="5" class="inv-empty">No customers yet. Customers appear here once they pay an invoice.</td></tr>';
            return;
          }
          body.innerHTML = _custRows.map(function(c){
            var spent = Number(c.total_spent || c.totalspent || c.total_spent) || 0;
            var lastDate = c.last_purchase || c.lastpurchase || c.last_purchase || "";
            if(lastDate) lastDate = new Date(lastDate).toLocaleDateString();
            return '<tr>'
              + '<td style="color:#e2e8f0;">' + (c.buyer_name || c.buyername || "") + '</td>'
              + '<td>' + (c.buyer_email || c.buyeremail || "") + '</td>'
              + '<td>' + (c.order_count || c.ordercount || 0) + '</td>'
              + '<td style="color:#10b981;">$' + spent.toFixed(2) + '</td>'
              + '<td style="color:#64748b;">' + lastDate + '</td>'
              + '</tr>';
          }).join("");
        } catch(err){ console.error("LOAD_CUSTOMERS_ERROR", err); }
      }

      document.getElementById("custExportBtn").addEventListener("click", function(){
        if(!_custRows.length) return;
        var csv = "Name,Email,Orders,Total Spent,Last Purchase\n";
        _custRows.forEach(function(c){
          var name = (c.buyer_name || c.buyername || "").replace(/"/g, '""');
          var email = (c.buyer_email || c.buyeremail || "").replace(/"/g, '""');
          var spent = (Number(c.total_spent || c.totalspent) || 0).toFixed(2);
          var lastDate = c.last_purchase || c.lastpurchase || "";
          if(lastDate) lastDate = new Date(lastDate).toLocaleDateString();
          csv += '"' + name + '","' + email + '",' + (c.order_count || c.ordercount || 0) + ',' + spent + ',"' + lastDate + '"\n';
        });
        var blob = new Blob([csv], { type: "text/csv" });
        var a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "customers.csv";
        a.click();
      });

      /* ‚îÄ‚îÄ‚îÄ Marketing tab ‚îÄ‚îÄ‚îÄ */
      var _mktCustCount = 0;
      async function loadMarketing(){
        try {
          var resp = await fetch("/api/seller/customers");
          if(!resp.ok) return;
          var rows = await resp.json();
          _mktCustCount = rows.length;
          document.getElementById("mktSendBtn").textContent = "Send to " + _mktCustCount + " customer" + (_mktCustCount !== 1 ? "s" : "");
        } catch(err){ console.error("LOAD_MARKETING_ERROR", err); }
      }

      document.getElementById("mktSendBtn").addEventListener("click", async function(){
        var subject = document.getElementById("mktSubject").value.trim();
        var message = document.getElementById("mktMessage").value.trim();
        if(!subject || !message){ alert("Please fill in both subject and message."); return; }
        var btn = document.getElementById("mktSendBtn");
        var status = document.getElementById("mktSendStatus");
        btn.disabled = true;
        btn.textContent = "Sending...";
        status.style.display = "none";
        try {
          var resp = await fetch("/api/seller/broadcast", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ subject: subject, message: message })
          });
          var result = await resp.json();
          if(!resp.ok){ status.style.color = "#ef4444"; status.textContent = result.error || "Send failed"; status.style.display = "block"; return; }
          status.style.color = "#10b981";
          status.textContent = "Sent to " + (result.sent || 0) + " customer" + ((result.sent || 0) !== 1 ? "s" : "") + "!";
          status.style.display = "block";
          document.getElementById("mktSubject").value = "";
          document.getElementById("mktMessage").value = "";
        } catch(err){ console.error("BROADCAST_SEND_ERROR", err); status.style.color = "#ef4444"; status.textContent = "Send failed"; status.style.display = "block"; }
        finally { btn.disabled = false; btn.textContent = "Send to " + _mktCustCount + " customer" + (_mktCustCount !== 1 ? "s" : ""); }
      });

      document.getElementById("mktExportBtn").addEventListener("click", function(){
        document.getElementById("custExportBtn").click();
      });

      watchTab("overview", loadDashboardStats);
      watchTab("invoices", loadInvoices);
      watchTab("orders", function(){ loadDeposits(); loadCashDeposits(); });
      watchTab("products", loadProducts);
      watchTab("customers", loadCustomers);
      watchTab("marketing", loadMarketing);
      watchTab("analytics", loadAnalytics);
      watchTab("facebook", loadCtpWebhookUrl);
      watchTab("settings", function(){ loadSettings(); loadFacebookKey(); loadStripeStatus(); });

    })();
    </script>
  </body>
</html>
