<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sebastian Digital Town – Map</title>
    <style>
      :root{
        --bg:#070b10;
        --panel:#0f1722;
        --panel2:#0b1220;
        --border:#223149;
        --text:#e8eef6;
        --muted:#9fb0c3;
        --accent:#2e93ff;
        --mint:#00ffae;
        --warn:#ffcc00;
        --shadow: 0 18px 55px rgba(0,0,0,.45);
        --r:14px;
      }

      *{ box-sizing:border-box; }
      body{
        margin:0;
        font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
        background: radial-gradient(circle at 20% 15%, rgba(46,147,255,.16), transparent 45%),
                    radial-gradient(circle at 85% 70%, rgba(0,255,170,.10), transparent 45%),
                    linear-gradient(180deg, #070b10, #05070b);
        color:var(--text);
      }

      header{
        position:sticky; top:0; z-index:10;
        padding:12px 16px;
        background: rgba(10,14,20,.86);
        backdrop-filter: blur(10px);
        border-bottom:1px solid rgba(255,255,255,.06);
      }

      .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
      .title{
        display:flex; align-items:center; gap:10px;
        font-weight:900; letter-spacing:.3px;
      }
      .dot{
        width:10px; height:10px; border-radius:999px;
        background: var(--mint);
        box-shadow: 0 0 18px rgba(0,255,170,.45);
      }
      .pill{
        display:inline-flex; align-items:center; gap:6px;
        padding:4px 10px;
        border-radius:999px;
        border:1px solid rgba(255,255,255,.10);
        background: rgba(15,23,34,.65);
        font-size:12px;
        color:#cfe3ff;
      }
      .muted{ color:var(--muted); font-size:12px; }
      code{ background: rgba(255,255,255,.06); padding:2px 7px; border-radius:8px; border:1px solid rgba(255,255,255,.08); }

      .layout{
        display:grid;
        grid-template-columns: 1.45fr 1fr;
        gap:12px;
        padding:12px;
        max-width: 1480px;
        margin: 0 auto;
      }

      .card{
        background: rgba(15,23,34,.78);
        border:1px solid rgba(255,255,255,.10);
        border-radius: var(--r);
        box-shadow: var(--shadow);
        overflow:hidden;
      }

      .cardHead{
        padding:12px 12px 10px 12px;
        border-bottom:1px solid rgba(255,255,255,.07);
        display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      }
      .cardHead h3{ margin:0; font-size:16px; letter-spacing:.2px; }
      .cardBody{ padding:12px; }

      /* MAP */
      .mapWrap{
        position: relative;
        min-height: 640px;
        border-radius: 14px;
        border:1px solid rgba(255,255,255,.10);
        background:
          radial-gradient(circle at 30% 20%, rgba(46,147,255,.18), transparent 45%),
          radial-gradient(circle at 80% 70%, rgba(0,255,170,.10), transparent 45%),
          linear-gradient(180deg, #0b1220, #070b10);
      }
      .mapGrid{
        position:absolute; inset:0;
        background-image:
          linear-gradient(rgba(255,255,255,0.04) 1px, transparent 1px),
          linear-gradient(90deg, rgba(255,255,255,0.04) 1px, transparent 1px);
        background-size: 46px 46px;
        opacity: .55;
        pointer-events:none;
      }

      .district{
        position:absolute;
        width: 270px;
        height: 122px;
        border-radius: 18px;
        padding: 12px;
        cursor:pointer;
        border: 1px solid rgba(255,255,255,.12);
        background: rgba(10,14,20,.45);
        box-shadow: 0 10px 45px rgba(0,0,0,.35);
        transition: transform .14s ease, border-color .14s ease, background .14s ease;
      }
      .district:hover{
        transform: translateY(-3px);
        border-color: rgba(46,147,255,.55);
        background: rgba(12,18,28,.58);
      }
      .district.active{
        border-color: rgba(0,255,170,.55);
        box-shadow: 0 14px 60px rgba(0,255,170,.10);
      }

      .dTitle{ font-weight:900; letter-spacing:.2px; display:flex; align-items:center; gap:8px; }
      .dIcon{ width:18px; height:18px; opacity:.9; }
      .dMeta{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
      .badge{
        font-size:12px;
        padding:3px 9px;
        border-radius:999px;
        border:1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.06);
        color:#d7e8ff;
      }

      #d-live { left: 40%; top: 14%; width: 330px; }
      #d-service { left: 16%; top: 45%; }
      #d-market { left: 58%; top: 45%; }
      #d-retail { left: 41%; top: 72%; width: 330px; }
      #d-civic { left: 8%; top: 72%; width: 310px; }

      .legend{
        position:absolute;
        right: 12px; bottom: 12px;
        border-radius: 14px;
        padding: 10px 12px;
        border:1px solid rgba(255,255,255,.10);
        background: rgba(10,14,20,.55);
        max-width: 340px;
        font-size:12px;
        color:#cfe3ff;
      }

      /* RIGHT PANEL */
      h4{ margin:10px 0 6px 0; font-size:13px; letter-spacing:.2px; }
      hr{ border:none; border-top:1px solid rgba(255,255,255,.08); margin: 12px 0; }

      .list{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
      .item{
        border:1px solid rgba(255,255,255,.10);
        border-radius: 12px;
        padding: 10px;
        background: rgba(10,14,20,.30);
        transition: border-color .14s ease, background .14s ease, transform .14s ease;
      }
      .item:hover{
        border-color: rgba(46,147,255,.40);
        background: rgba(12,18,28,.40);
        transform: translateY(-1px);
      }

      input, textarea{
        width:100%;
        padding:10px;
        border-radius: 12px;
        border:1px solid rgba(255,255,255,.10);
        background: rgba(7,11,16,.55);
        color: var(--text);
        outline:none;
      }
      textarea{ min-height: 80px; }

      button{
        padding:10px 12px;
        border-radius: 12px;
        border:1px solid rgba(255,255,255,.12);
        background: rgba(7,11,16,.55);
        color: var(--text);
        cursor:pointer;
        transition: transform .12s ease, border-color .12s ease, background .12s ease;
      }
      button:hover{
        transform: translateY(-1px);
        border-color: rgba(46,147,255,.45);
        background: rgba(15,23,34,.55);
      }

      .debugBox{
        border:1px solid rgba(255,204,0,.25);
        background: rgba(255,204,0,.07);
        border-radius: 14px;
        padding: 10px 12px;
      }
      .mono{ font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; white-space: pre-wrap; }

      /* Metrics */
      .metricsGrid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; margin-top:10px; }
      .metric{ border:1px solid rgba(255,255,255,.10); border-radius: 12px; padding: 10px; background: rgba(0,0,0,.12); }
      .metric .k{ font-size:12px; color:var(--muted); }
      .metric .v{ font-size:18px; font-weight:900; margin-top:4px; }
      .healthBig{ display:flex; align-items:center; gap:10px; margin-top:10px; }
      .healthBig .v{ font-size:30px; font-weight:900; }
      .bar{ height: 10px; border-radius: 999px; background: rgba(255,255,255,.08); overflow:hidden; flex:1; }
      .bar > div{ height:100%; width:0%; background: rgba(0,255,170,.55); }

      @media (max-width: 1100px){
        .layout{ grid-template-columns: 1fr; }
        .mapWrap{ min-height: 560px; }
      }
    </style>
  </head>

  <body>
    <header>
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <div class="title"><span class="dot"></span> Sebastian Digital Town</div>
          <span class="pill" id="apiStatus">API: …</span>
          <span class="muted">Sebastian only • <code>/ui</code></span>
        </div>
        <div class="row">
          <span class="pill">Town Health Index: <span id="healthIndexInline">—</span></span>
        </div>
      </div>
    </header>

    <div class="layout">
      <div class="card">
        <div class="cardHead">
          <div>
            <h3>Town Map</h3>
            <div class="muted">Enter a district → pick a place → operate the town.</div>
          </div>
          <div class="muted">Prototype v1</div>
        </div>

        <div class="cardBody">
          <div class="mapWrap">
            <div class="mapGrid"></div>

            <div class="district" id="d-live" data-district="4">
              <div class="dTitle">
                <svg class="dIcon" viewBox="0 0 24 24" fill="none"><path d="M4 18V6l8-3 8 3v12l-8 3-8-3Z" stroke="currentColor" opacity=".9"/><path d="M8 12h8" stroke="currentColor"/></svg>
                Marina / Live Hall
              </div>
              <div class="dMeta"><span class="badge">Live: 0</span><span class="badge">Events: 0</span></div>
            </div>

            <div class="district" id="d-service" data-district="2">
              <div class="dTitle">
                <svg class="dIcon" viewBox="0 0 24 24" fill="none"><path d="M14 7l3 3-7 7H7v-3l7-7Z" stroke="currentColor"/><path d="M13 8l3 3" stroke="currentColor"/></svg>
                Service Row
              </div>
              <div class="dMeta"><span class="badge" id="badge-service-places">Places: …</span></div>
            </div>

            <div class="district" id="d-market" data-district="1">
              <div class="dTitle">
                <svg class="dIcon" viewBox="0 0 24 24" fill="none"><path d="M4 7h16l-1 12H5L4 7Z" stroke="currentColor"/><path d="M8 7V5a4 4 0 0 1 8 0v2" stroke="currentColor"/></svg>
                Market Square
              </div>
              <div class="dMeta">
                <span class="badge" id="badge-market-places">Places: …</span>
                <span class="badge" id="badge-market-listings">Listings: …</span>
              </div>
            </div>

            <div class="district" id="d-retail" data-district="3">
              <div class="dTitle">
                <svg class="dIcon" viewBox="0 0 24 24" fill="none"><path d="M6 3h12l2 5H4l2-5Z" stroke="currentColor"/><path d="M5 8v13h14V8" stroke="currentColor"/></svg>
                Retail Way
              </div>
              <div class="dMeta"><span class="badge" id="badge-retail-places">Places: …</span></div>
            </div>

            <div class="district" id="d-civic" data-district="5">
              <div class="dTitle">
                <svg class="dIcon" viewBox="0 0 24 24" fill="none"><path d="M3 10l9-6 9 6v10H3V10Z" stroke="currentColor"/><path d="M9 20v-6h6v6" stroke="currentColor"/></svg>
                Town Hall
              </div>
              <div class="dMeta"><span class="badge">Civic</span></div>
            </div>

            <div class="legend">
              <div><strong>Legend</strong></div>
              <div class="muted">Place-based discovery (not street-accurate).</div>
              <div style="margin-top:6px;">✅ Click district → click place → manage listings + messages</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div>
            <h3>Sebastian Control Panel</h3>
            <div class="muted" id="rightHint">Town health + operations.</div>
          </div>
          <div class="muted" id="metricsTime">—</div>
        </div>

        <div class="cardBody">
          <div class="debugBox">
            <strong>Status / Debug</strong>
            <div class="mono" id="debug">(ready)</div>
          </div>

          <hr />

          <h4>Town Health</h4>
          <div class="healthBig">
            <div style="min-width:120px;">
              <div class="muted">Index</div>
              <div style="font-size:30px;font-weight:900;" id="healthIndex">—</div>
            </div>
            <div class="bar"><div id="healthBar"></div></div>
          </div>

          <div class="metricsGrid">
            <div class="metric"><div class="k">Places</div><div class="v" id="mPlaces">—</div></div>
            <div class="metric"><div class="k">Active Listings</div><div class="v" id="mActiveListings">—</div></div>
            <div class="metric"><div class="k">Total Listings</div><div class="v" id="mTotalListings">—</div></div>
            <div class="metric"><div class="k">Sold Listings</div><div class="v" id="mSoldListings">—</div></div>
            <div class="metric"><div class="k">Conversations</div><div class="v" id="mConversations">—</div></div>
            <div class="metric"><div class="k">Messages</div><div class="v" id="mMessages">—</div></div>
          </div>

          <hr />

          <h4>Places</h4>
          <div class="list" id="places"></div>

          <hr />

          <h4>Listings</h4>
          <div class="list" id="listings"></div>

          <h4>Create Listing</h4>
          <div class="muted">Creates a listing for the selected place.</div>
          <div style="margin-top:8px;"><input id="newTitle" placeholder="Title" /></div>
          <div style="margin-top:8px;"><input id="newDesc" placeholder="Description" /></div>
          <div class="row" style="margin-top:8px;">
            <input id="newQty" placeholder="Quantity" value="1" />
            <input id="newPrice" placeholder="Price" value="99" />
          </div>
          <div class="row" style="margin-top:8px;"><button id="createListingBtn">Create Listing</button></div>

          <hr />

          <h4>Conversations</h4>
          <div class="row">
            <button id="viewerBuyer">Viewer: buyer</button>
            <button id="viewerSeller">Viewer: seller</button>
            <button id="markReadBtn">Mark Read</button>
          </div>
          <div class="muted" id="viewerLabel"></div>
          <div class="list" id="conversations"></div>

          <hr />

          <h4>Messages</h4>
          <div class="list" id="messages"></div>
          <div style="margin-top:10px;"><input id="sender" placeholder="sender (buyer or seller)" value="buyer" /></div>
          <div style="margin-top:8px;"><textarea id="msgText" placeholder="type a message..."></textarea></div>
          <div class="row" style="margin-top:8px;"><button id="sendMsg">Send Message</button></div>
        </div>
      </div>
    </div>

    <script src="/app.js?v=polish1"></script>
  </body>
</html>

